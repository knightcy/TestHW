!function(){Business_Modules={Account:{}};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel"),RoleToMenuPage={roleid:{type:Sequelize.STRING,allowNull:!1},menuinfo:{type:Sequelize.STRING(7e3),allowNull:!1}};sequelizeModel&&sequelizeModel.registerModel("RoleToMenuPage","roletomenupage",RoleToMenuPage),Business_Modules.Account.Model=sequelizeModel;var fw=require("../../../libs/f"),ge=require("../../../libs/g"),utilities=fw.Framework.Utilities,formidable=require("formidable"),Consts=fw.Framework.Consts,ErrorCode=Consts.ErrorCode,ActionStatus=Consts.ActionStatus,Module=fw.Framework.Module,seqModels=utilities.loadSingleInstance("sequelizeModel"),mysql=require("mysql"),config=require("../../config"),EventBus=fw.Framework.EventBus,httpAccess=fw.Framework.HttpAccess,fs=require("fs"),topUtil=ge.General.SMS.Crypto,securityModule=function(){this._name="security"},vendorContactAsEmployee=!0;utilities.extend(securityModule,Module,{getExports:function(){return["getAccountList","addUserAccount","updateUserAccount","deleteUserAccount","lockAccount","getVendorContactList","getRolesList","addAccountForVendorContact","deleteAccountOfVendorContact"]},addUserAccount:function(n,t){var a=n.user;if(n.companyid=a.companyid,n)if(n.verification=1,utilities.isNull(n)){t({code:"900004",cause:"accountBaseInfo is not avaliable!"},null)}else n.pwd=topUtil.md5(n.pwd),seqModels.query("Account",{where:{aid:n.aid}},function(e){if(e.length<=0)seqModels.seq.transaction(function(t){return seqModels.insertWithTrans("Account",n,t).then(function(){var e={employeeid:utilities.getGUID(10),name:n.name,position:n.position,phone:n.cellphone,email:n.email,companyid:a.companyid,account:n.aid,rolename:n.rolename,creater:a.aid,createtime:new Date,comments:""};return seqModels.insertWithTrans("Employee",e,t)})}).then(function(e){t(null,e)}).catch(function(e){t(e,null)});else{t({code:"900003",cause:"AccountBaseInfo is already exists!"},null)}},function(e){t({code:"900001",cause:e},null)})},updateUserAccount:function(t,n){if(t)if(utilities.isNull(t)){n({code:"900004",cause:"venorId is not avaliable!"},null)}else delete t.createtime,seqModels.seq.transaction(function(e){return seqModels.updateWithTrans("Account",t,{aid:t.oldaid},e)}).then(function(e){n(null,e)}).catch(function(e){n({code:"900001",cause:e},null)})},getAccountList:function(e,a){var t=e.user,o="select info.* from (select accounts.* from accounts,employees where accounts.aid=employees.account)info left join roles on info.rolename = roles.roleid where info.companyid=:COMPANYID",n="select count(*) as count from (select accounts.* from accounts,employees where accounts.aid=employees.account)info left join roles on info.rolename = roles.roleid where info.companyid=:COMPANYID",i=e.selectFilter.status,r=e.selectFilter.aid,s=e.start,u=e.length,l={COMPANYID:t.companyid},d={COMPANYID:t.companyid};utilities.isNull(i)||(o+=" and verification = :VERIFICATION ",n+=" and verification = :VERIFICATION ",l.VERIFICATION=i,d.VERIFICATION=i),utilities.isNull(r)||""==r||(o+=" and aid like :AID ",l.AID=r+"%",n+=" and aid like :AID ",d.AID=r+"%"),utilities.isNull(s)||utilities.isNull(u)||(o+=" limit :Start,:Length",l.Start=s,l.Length=u),seqModels.queryFromSql(n,d,function(n){seqModels.queryFromSql(o,l,function(e){var t={data:e,length:n[0].count};a(null,t)},function(e){a({code:"900001",cause:e},null)})},function(e){a({code:"900001",cause:e},null)})},deleteUserAccount:function(e,t){var n=e.aid;seqModels.delete("Account",{aid:n},function(e){t(null,e)},function(e){t({code:"900001",cause:e},null)})},lockAccount:function(e,t,n){if(e)if(utilities.isNull(e)){n({code:"900004",cause:"accountId is not avaliable!"},null)}else{var a={};a.verification=1==t?1:0,seqModels.update("Account",a,{aid:e},function(e){n(null,e)},function(e){n({code:"900001",cause:e},null)})}},getRolesList:function(e,t){var n,a=e.selectFilter.searchText,o=e.selectFilter.type;n=utilities.isNull(o)||"selectCount"!=o?"select * from roles where roleid not in (:ADMIN)":"select count(*) as count from roles where roleid not in (:ADMIN) ";var i={ADMIN:"admin"};utilities.isNull(a)||""==a||(n+=" and (name like :SearchText or 'desc' like :SearchText) ",i.SearchText=a+"%"),n+=" order by id ",utilities.isNull(e.start)||utilities.isNull(e.everyPageCount)||(n+=" limit :Start, :Count",i.Start=parseInt(e.start),i.Count=parseInt(e.everyPageCount)),seqModels.queryFromSql(n,i,function(e){t(null,{data:e})},function(e){t({code:"900001",cause:e},null)})},getAuthorizationsList:function(e,a){var t=e.start,n=e.length,o=e.selectFilter.authorizationName,i=e.status,r=" select * from authorizations where 1=1 ",s={};utilities.isNull(o)||""==o||(r+=" and  api_name like :Name",s.Name=o+"%"),utilities.isNull(i)||(r+=" and status =:Status ",s.Status=i),utilities.isNull(t)||utilities.isNull(n)||(r+=" limit :Start, :Count",s.Start=parseInt(t),s.Count=parseInt(n)),seqModels.queryFromSql("select count(*) as count from authorizations  where 1=1 ",{},function(n){seqModels.queryFromSql(r,s,function(e){var t={data:e,length:n[0].count};a(null,t)},function(e){a({code:"900001",cause:e},null)})},function(e){a({code:"900001",cause:e},null)})},getRoleDetail:function(t,n){seqModels.queryFromSql("select * from roles where roleid=:RoleId ",{RoleId:t},function(e){0<e.length?n(null,e[0]):n({code:"900002",cause:"_vendor: "+t+" is not exists error!"},null)},function(e){n({code:"900001",cause:e},null)})},checkRoleUsed:function(e,t){var n={RoleId:e.roleid};seqModels.queryFromSql("select count(*) as count from accounts where rolename = :RoleId ",n,function(e){t(null,e[0].count)},function(e){t(e,null)})},updateEmployee:function(e,t){var n=e.employee;n.aid=n.account,seqModels.seq.transaction(function(e){return seqModels.updateWithTrans("Employee",n,{account:n.account},e).then(function(){return seqModels.updateWithTrans("Account",n,{aid:n.aid},e)})}).then(function(e){t(null,e)}).catch(function(e){t({code:"900001",cause:e},null)})},updatePwd:function(n,a){var e=n.oldpwd,o=n.newpwd,t={PWD:topUtil.md5(e)};seqModels.queryFromSql(" select count(*) as count from accounts where pwd =:PWD ",t,function(e){if(0!=e[0].count){var t={aid:n.aid,pwd:topUtil.md5(o)};seqModels.seq.transaction(function(e){return seqModels.updateWithTrans("Account",t,{aid:n.aid},e)}).then(function(e){a(null,e)}).catch(function(e){a({code:"900001",cause:e},null)})}else{a({code:"900001",cause:"modifyOldpwderr"},null)}},function(e){a({code:"900001",cause:e},null)})},getSettings:function(m,f){var p=[];seqModels.queryFromSql("select * from settings",{},function(e){if(0<e.length){var t=e[0].value.toString("utf-8"),n=JSON.parse(t).auth;if(n)if(m.roleid){var a=m.roleid,o=n.roleMenu[a];if(o)for(var i=0,r=o.length;i<r;i++){if((g=o[i]).children)for(var s=0,u=g.children.length;s<u;s++){var l=g.children[s],d={groupName:g.name,itemsName:l.name,link:l.link,icon:l.icon};p.push(d)}}}else{var c=n.roleMenu.admin;for(i=0,r=c.length;i<r;i++){var g;if((g=c[i]).children)for(s=0,u=g.children.length;s<u;s++){l=g.children[s],d={groupName:g.name,itemsName:l.name,path:l.path,icon:l.icon};p.push(d)}else p.push({groupName:g.name,itemsName:g.name,path:g.path,icon:g.icon})}}f(null,{data:p,authsettings:n})}else f(null,null)},function(e){f(e,null)})}}),Business_Modules.Account.securityModule=securityModule;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,ActionStatus=Consts.ActionStatus,ErrorCode=Consts.ErrorCode,RTDataModule=fw.Framework.RTDataModule,EventBus=utilities.loadSingleInstance("EventBus"),RTData=fw.Framework.RTData,exec=require("child_process").exec,securityModule=Business_Modules.Account.securityModule,AccountModule=function(){utilities.callSuper(AccountModule,this,arguments),this._name="account",this._clientCache={},this.timeoutID="",this.CHECKSESSIONTIME=6e3,this._securityModule=new securityModule,this.focusedEventArray=[{event:Consts.EventType.InnerSignin,onEvent:"onSignEvent"},{event:Consts.EventType.UpdateSession,onEvent:"onUpdateSessionInfo"}],this.DataContainerArray=[]};utilities.extend(AccountModule,RTDataModule,{getExports:function(){return["userLogin","getSessionUser","systemExit","loadUser","addUser","getAuthCode","getUserDataTableData","getJobType","updateJobWeightInfo","getRoleidByName","changeIp","getAllNetWorkNames","loginWithADInfo","getAccoutsbyParams","getEmailByAid","validateRoleMenu","DeleteUserAccount","AddUserAccount","GetAuthorizationsList","GetRolesList","GetRoleDetail","CheckRoleUsed","UpdateUserAccount","GetSettings","GetAccountList","ResetAccountPassword","LockAccount","isLoggedInManager","UpdatePwd","reqEmployeeDetails"]},loadModuleSettings:function(e){},checkSession:function(){for(var e=this,t=new Date,n=this._clientCache,a=Object.getOwnPropertyNames(n),o=0;o<a.length;o++){var i=n[a[o]];i&&i.lastDate&&t-i.lastDate>this._platform._settings.moduleSettings.account.OUTLINE_TIME&&(utilities.log("10分钟释放缓存："+JSON.stringify(n[a[o]].user)),this._clientCache[a[o]]=null)}this.timeoutID=setTimeout(function(){e.checkSession()},this.CHECKSESSIONTIME)},onUpdateSessionInfo:function(e,t){var n=e.id,a=this._clientCache[n];a||(a={id:n,user:e.user},this._clientCache[n]=a),t&&utilities.copySimpleObject(t,this._clientCache[n]),this._clientCache[n].lastDate=new Date},onSignEvent:function(e){var t=e.account;e.callback&&e.callback(t),utilities.log("用户："+t.aid+" 登录成功！")},hasSessionInfo:function(e){return!!this._clientCache[e]},runningOnPlatform:function(){utilities.invokeSuper(AccountModule,"runningOnPlatform",this,arguments),this.checkSession()},preRunningOnPlatform:function(){utilities.invokeSuper(AccountModule,"preRunningOnPlatform",this,arguments)},initRTDataModule:function(){utilities.invokeSuper(AccountModule,"initRTDataModule",this,arguments)},releaseSession:function(e){var t=e.id;this._clientCache[t]&&(this._clientCache[t]=null)},getSessionUser:function(e,t,n){var a={type:"getSessionUser"},o=e.session.user;a.status=ActionStatus.S,a.result={user:o},t.json(a)},validateRoleMenu:function(e,d,t){var c={type:"validateRoleMenu"},n=e.session.user,g=e.body;console.log("ddd2",n),n&&n.rolename&&this._platform.runModule("auth","getUserMenu",[n.rolename,function(e,t){if(console.log("ddd1",e),e){var n=[],a=[],o=g.menu_type,i=g.menu_path,r=function(){c.status=ActionStatus.F,d.json(c)},s=function(e){if(0<e.length){for(var t=!1,n=0;0<(n<e.length);n++){e[n].path.split("/")[2]==i.split("/")[2]&&(t=!0)}t?(c.status=ActionStatus.S,d.json(c)):r()}else r()};if(console.log("ddd",e),0<e.length){for(var u=0;u<e.length;u++){var l=e[u];"asset-manage"==l.path?n=l.children:"warehouse-manage"==l.path&&(a=l.children)}"asset-manage"==o?s(n):"warehouse-manage"==o&&s(a)}else r()}else r()}])},systemExit:function(e,t,n){var a={type:"systemExit"};e.session.islogin=!1,t.clearCookie("access"),this._platform.releaseSession(e.session),e.session.destroy(function(){var e={logid:utilities.getGUID(20),type:"runningOnPlatform",content:JSON.stringify({module:"account"}),category:"0",operator:"systemExit",createtime:new Date,operatorip:"172.0.0.1",result:"SUCCESS"};EventBus.fireEvent("log_addLogging",e),console.log(JSON.stringify(e)),a.status=ActionStatus.S,t.json(a)})},getRoleidByName:function(e,n,t){var a={type:"getRoleidByName"},o=e.body;e.session.user;model.query("Ticket_cost_info",{where:{name:o.name}},function(e){var t=e[i].dataValues;a.result={data:t},a.status=ActionStatus.S,n.json(a)},function(e){a.status=ActionStatus.F,a.error={cause:e.message},n.json(a)})},autoLogin:function(n,a,e,o){var t={type:"autoLogin"},i=this,r=function(e,t){t?o&&o():"GET"==n.method?a.render("toIndex.ejs"):a.json(e)};model.queryFromSql("select * from eflow_employees eui where eui.employee_code=:aid",{aid:e},function(e){1==e.length&&i.loginSuccessUnit(n,a,t,e[0],r)},function(e){r(null,{message:e})})},loginSuccessUnit:function(i,r,s,u,l){var d=new RTData,c=this,e="select r.* from roles r,roletoaccounts ra where ra.userid = '"+u.employee_code+"'and r.roleid = ra.roleid ";model.queryFromSql(e,{},function(e){var t=e.length;if(0<t){for(var n=[],a=[],o=0;o<t;o++)a.push(e[o].roleid),n.push(e[o].name);d.role=a,d.rolename=n}else d.role=["common"],d.rolename=["common"];utilities.copySimpleObject({lastTime:new Date,aid:u.employee_code,userid:u.employee_code},d),utilities.copySimpleObject(u,d),d.rolekey=c._platform.runModule("auth","updateValidateSuccess",[i,r,d,s,l]),EventBus.fireEvent(Consts.EventType.UpdateSession,i.session),EventBus.fireEvent(Consts.EventType.Signin,d.system_user_code,d.employee_code)},function(e){l(null,{message:e})})},loginWithADInfo:function(a,o,e){var i={type:"loginWithADInfo"},r=this,s=!1,t=a.url.substr(1,a.url.length-1).replace("/","\\");-1<t.indexOf("loginWithToken")&&(s=!0,t=t.replace("loginWithToken\\",""));var n="select * from usertokens ut where ut.token='"+t+"' ";model.queryFromSql(n,{},function(t){if(1==t.length){var e="select * from eflow_employees eui where eui.user_eflow_windows_id='"+t[0].ad_account+"' ";s&&(e="select * from eflow_employees eui where eui.employee_code='"+t[0].ad_account+"' ");var n=function(e,t){if(t)o.render("toLogin.ejs");else{var n=JSON.stringify(e.result.user),a=JSON.stringify(e.result.menusettings);o.render("toIndex.ejs",{user:n,menusettings:a})}};model.queryFromSql(e,{},function(e){1==e.length?r.loginSuccessUnit(a,o,i,e[0],n):o.render("toLogin.ejs")},function(e){o.render("toLogin.ejs"),console.log(e)}),s||model.queryFromSql("delete from usertokens where ad_account='"+t[0].ad_account+"';",{},function(e){},function(e){console.log("请注意：用户"+t[0].ad_account+"AD登录后清空token失败，可能会造成用户可重复使用token登录系统！您可以手工清除该用户的token信息:delete from usertokens where ad_account='"+t[0].ad_account+"';")})}else o.render("toLogin.ejs")},function(e){o.render("toLogin.ejs"),console.log(e)})},getAccoutsbyParams:function(e,n,t){var a={type:"getAccoutsbyParams"},o=e.body,i={},r={},s="select a.*, r.name as rname from accounts a left join roles r on a.rolename = r.roleid where 1=1 ",u=" select count(1) as num from accounts where 1=1 ";o.companyid&&(r.companyid=o.companyid,i.companyid=o.companyid,s+=" and companyid=:companyid ",u+=" and companyid=:companyid "),o.aid&&(r.aid=o.aid,i.aid=o.aid,s+=" and aid=:aid ",u+=" and aid=:aid "),o.name&&(r.name=o.name,i.NAME=o.name,s+=" and name=:NAME ",u+=" and name=:NAME "),o.rolename&&(r.rolename=o.rolename,i.rolename=o.rolename,s+=" and rolename in (:rolename) ",u+=" and rolename in (:rolename) "),o.start&&o.length&&(s+=" limit :start, :length ",r.start=o.start,r.length=o.length),model.queryFromSql(u,i,function(t){model.queryFromSql(s,r,function(e){a.result={length:t[0].num,data:e},a.status=Status.S,n.json(a)},function(e){a.error=e,a.status=Status.F,n.json(a)})},function(e){a.error=e,a.status=Status.F,n.json(a)})},getEmailByAid:function(e,n){if(e){var t={AID:e};model.queryFromSql(" select email from accounts where aid=:AID ",t,function(e){var t=e[0].email;n(t)},function(e){n(null,e)})}},DeleteUserAccount:function(e,a,t){var o={action:"DeleteUserAccount"},i=e.session.user,r=utilities.getNodeClientIp(e),n=e.body;return this._securityModule.deleteUserAccount(n,function(e,t){if(e){o.status=ActionStatus.F,o.error=e,a.json(o);var n={logid:utilities.getGUID(20),type:"Delete User",content:JSON.stringify({module:"account"}),category:"0",operator:i?i.aid:"",createtime:new Date,operatorip:r||"",result:"Fail"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n))}else o.status=ActionStatus.S,o.result=t,a.json(o),n={logid:utilities.getGUID(20),type:"Delete User",content:JSON.stringify({module:"account"}),category:"0",operator:i?i.aid:"",createtime:new Date,operatorip:r||"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n))})},AddUserAccount:function(e,a,t){var o={action:"AddUserAccount"},i=e.session.user,n=e.body,r=utilities.getNodeClientIp(e),s=n.accountInfo;return s.user=i,this._securityModule.addUserAccount(s,function(e,t){if(e){o.status=ActionStatus.F,o.error=e,a.json(o);var n={logid:utilities.getGUID(20),type:"AddUser",content:JSON.stringify({module:"account"}),category:"0",operator:i?i.aid:"",createtime:new Date,operatorip:r||"",result:"SUCCESS"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n))}else o.status=ActionStatus.S,o.result={data:t},a.json(o),n={logid:utilities.getGUID(20),type:"AddUser",content:JSON.stringify({module:"account"}),category:"0",operator:i?i.aid:"",createtime:new Date,operatorip:r||"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n))})},addLog:function(e,t,n){var a={logid:utilities.getGUID(20),type:e,content:t,operator:n.session.aid,category:"0",createtime:new Date,operatorip:"172.0.0.1",result:"SUCCESS"};EventBus.fireEvent("log_addLogging",a),console.log(JSON.stringify(a))},ResetAccountPassword:function(t,n,e){var a={type:"ResetAccountPassword"},o=t.body,i=utilities.getGUID(5,10),r={pwd:topUtil.md5(i)},s={aid:o.aid};model.update("Account",r,s,function(e){a.status=ActionStatus.S,a.data=i,n.json(a),this.addLog("Reset Password","Reset Password Success",t)},function(e){utilities.responsDBErrorAction(n,a,e),this.addLog("Reset Password","Reset Password Error: "+JSON.stringify(e),t)})},UpdateUserAccount:function(e,a,t){var o={action:"UpdateUserAccount"},i=e.session.user,n=e.body,r=utilities.getNodeClientIp(e),s=n.accountInfo;return this._securityModule.updateUserAccount(s,function(e,t){if(e){o.status=ActionStatus.F,o.error=e,a.json(o);var n={logid:utilities.getGUID(20),type:"Upload User",content:JSON.stringify({module:"account"}),category:"0",operator:i?i.aid:"",createtime:new Date,operatorip:r||"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n))}else o.status=ActionStatus.S,o.result={data:t},a.json(o),n={logid:utilities.getGUID(20),type:"Update User",content:JSON.stringify({module:"account"}),category:"0",operator:i.aid?i.aid:"",createtime:new Date,operatorip:r||"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n))})},GetAuthorizationsList:function(e,n,t){var a={action:"GetAuthorizationsList"},o=(e.session.user,e.body);return o=utilities._handleDatatableSettings(o,["selectFilter"]),this._securityModule.getAuthorizationsList(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result=t),n.json(a)})},LockAccount:function(n,a,e){var o={action:"LockAccount"},t=(n.session.user,n.body),i=utilities._handleDatatableSettings(t,["aid","status"]),r=i.aid,s=i.status;return this._securityModule.lockAccount(r,s,function(e,t){e?(o.status=ActionStatus.F,o.error=e,a.json(o),this.addLog("Lock User","Lock User Error: "+JSON.stringify(e),n)):(o.status=ActionStatus.S,o.result={data:t},a.json(o),this.addLog("Lock User","Lock User Success",n))})},GetRolesList:function(e,n,t){var a={action:"GetRolesList"},o=(e.session.user,e.body);return this._securityModule.getRolesList(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result=t),n.json(a)})},GetRoleDetail:function(e,n,t){var a={action:"GetRoleDetail"},o=(e.session.user,e.body.roleid);return this._securityModule.getRoleDetail(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result=t),n.json(a)})},CheckRoleUsed:function(e,n,t){var a={action:"CheckRoleUsed"},o=e.body;return this._securityModule.checkRoleUsed(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result=t),n.json(a)})},GetSettings:function(e,n,t){var a={action:"GetSettings"},o=e.body;return this._securityModule.getSettings(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result=t),n.json(a)})},GetAccountList:function(e,n,t){var a={action:"GetAccountList"},o=e.session.user,i=e.body,r=utilities._handleDatatableSettings(i,["selectFilter"]);return r.user=o,this._securityModule.getAccountList(r,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result=t),n.json(a)})},isLoggedInManager:function(e,n,t){var a={type:"isLoggedInManager"},o=e.body.params.token;this._platform.runModule("auth","getTokenByKey",[o,function(e,t){t?(a.status=ActionStatus.S,a.result={msg:"已经登录"}):(a.status=ActionStatus.F,a.error={msg:"没有登录"}),n.json(a)}])},reqEmployeeDetails:function(e,n,t){var a=e.session.user,o={type:"reqEmployeeDetails"};this.checkEmployeeDetails(a.aid,function(e,t){e?(1==e.length&&(a.employeeInfo=e[0]),o.status=ActionStatus.S,o.result=a,n.json(o)):t&&utilities.responsDBErrorAction(n,o,t)})},checkEmployeeDetails:function(e,t){var n="select a.employeeid, b.phone,b.company_id as companyid,b.company_name as companyname, b.address,a.position from employees as a left join companies as b on a.companyid=b.company_id where a.account = '"+e+"'";model.queryFromSql(n,{},function(e){t&&t(e)},function(e){t&&t(null,e)})},UpdatePwd:function(e,n,t){var a={action:"UpdatePwd"},o=e.body;return o.aid=e.session.user.aid,this._securityModule.updatePwd(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result=t),n.json(a)})},changeIp:function(e,n,t){var a={action:"onChangeIp"},o=e.body,i=function(e,t){e?(a.status=0,a.error=e):(a.status=1,a.result={data:t}),n.json(a)};if(o){var r=o.ip,s=o.netmask,u=o.gateway,l=o.name;exec("sh business_module/sh/ipchange.sh "+l+" "+r+" "+u+" "+s,{detached:!0},function(e,t,n){i(null,"")})}else i("no parameter!!",null)},getAllNetWorkNames:function(e,i,t){var r={action:"getAllNetWorkNames"},s=(e.body,this.getIPAdress());exec("ifconfig | grep  \"Link\" | awk '{print $1}'",{detached:!0},function(e,t,n){var a,o;console.log(JSON.stringify(t)+":::"),o={ip:s,name:t},(a=null)?(r.status=0,r.error=a):(r.status=1,r.result={data:o}),i.json(r)})},getIPAdress:function(){var e=require("os").networkInterfaces(),t={};for(var n in e)for(var a=e[n],o=0;o<a.length;o++){var i=a[o];"IPv4"!==i.family||"127.0.0.1"===i.address||i.internal||(t[n]=i.address)}return t}}),Business_Modules.Account.Module=AccountModule,Business_Modules.Controller={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel");Business_Modules.Controller.Model=sequelizeModel;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,Consts=fw.Framework.Consts,Module=fw.Framework.Module,RTDataModule=fw.Framework.RTDataModule,seqModels=utilities.loadSingleInstance("sequelizeModel"),EventBus=utilities.loadSingleInstance("EventBus"),soap=require("soap"),http=require("http"),https=require("https"),iconv=require("iconv-lite");process.env.NODE_TLS_REJECT_UNAUTHORIZED="0";var WebServiceManager=function(){utilities.callSuper(WebServiceManager,this,arguments),this._name="WebServiceManager",this.WEBSERVICE_SOAP_TYPE="Soap",this.WEBSERVICE_REST_TYPE="Rest"};utilities.extend(WebServiceManager,Object,{runningOnPlatform:function(e){utilities.invokeSuper(WebServiceManager,"runningOnPlatform",this,[e])},callService:function(e,n){var t=e.serviceType,a=e.serviceConfigInfo,o=e.params;t===this.WEBSERVICE_SOAP_TYPE?this._handleSoapService(a,o,function(e,t){e?n(e):n(null,t)}):t===this.WEBSERVICE_REST_TYPE&&this._handleRestService(a,o,function(e,t){e?n(e):n(null,t)})},_handleSoapService:function(e,t,n){var a=this,o=e.valueUrl,i=e.url,r={webMethodName:e.webMethodName,params:e.params};a._initSoapProcess({valueUrl:o,url:i},function(e,t){e?n(e):t&&a._getDataByClient(t,r,function(e,t){e?n(e):n(null,t)})})},_handleRestService:function(e,t,o){var n={},a=e.http_type;n=a&&"https"===a?https:http;var i=this._initRestProcess(e,null),r=n.request(i,function(e){console.log("STATUS: "+e.statusCode),console.log("HEADERS: "+JSON.stringify(e.headers));var n=[],a=0;e.on("data",function(e){var t=e;n.push(t),a+=t.length}),e.on("end",function(){var e=Buffer.concat(n,a),t=iconv.decode(e,"utf-8");o(null,t.toString())})});r.on("error",function(e){console.log("problem with request: "+e.message),o(e)}),r.write(require("querystring").stringify(t)),r.end()},_initRestProcess:function(e,t){var n=null;return e.username&&e.password&&(n="Basic "+new Buffer(e.username+":"+e.password).toString("base64")),{hostname:e.host,port:e.port,path:e.path,method:e.method,headers:{accept:"*/*","Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",authorization:n||null}}},_initSoapProcess:function(e,n){var t=e.valueUrl,a=e.url;if(t&&a){var o={overrdeRootElement:{namespace:"xmlns:tns",xmlnsAttributes:[{name:"xmlns:ns",value:t}]}};soap.createClient(a,o,function(e,t){null!==e?n(e):t&&n(null,t),t.setSOAPAction(a)})}},_getDataByClient:function(e,t,n){if(e&&t){var a=t.webMethodName,o=t.params;e[a](o,function(e,t){e?n(e):t&&n(null,t)})}}}),Business_Modules.Controller.WebServiceManager=WebServiceManager;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,EventBus=utilities.loadSingleInstance("EventBus"),RTData=fw.Framework.RTData,acquisitionInstance=null,webServiceManager=Business_Modules.Controller.WebServiceManager,fs=require("fs"),ControllerModule=function(){utilities.callSuper(ControllerModule,this,arguments),this._name="ControllerModule"};utilities.extend(ControllerModule,RTDataModule,{getExports:function(){return["getSocketKeyManager","testCallService","callServiceManager","getShowEventManager","getShowTheme1DataManager","getAirmonitoringDataManager"]},runningOnPlatform:function(){utilities.invokeSuper(ControllerModule,"runningOnPlatform",this,arguments);this.importAssetInfo("")},getShowEventManager:function(e,t,n){t.json([testData.showEvent()])},getShowTheme1DataManager:function(e,t,n){var a=testData.showTheme1Data();encodeURI(JSON.stringify(a),"utf-8");t.json([a])},getAirmonitoringDataManager:function(e,t,n){t.json([{name:"pm25",value:10},{name:"pm10",value:9},{name:"no2",value:14},{name:"o3",value:11}])},importAssetInfo:function(e){this._importAssetHandle(__dirname+"/assetSourceExcel/importCategory_Staticfile.xlsx","importModelCategory"),this._importAssetHandle(__dirname+"/assetSourceExcel/importModel_Staticfile.xlsx","importModel")},_importAssetHandle:function(n,e){this._platform.runModule("asset",e,[{user:{aid:"sadmin"},excelPath:n},function(e,t){e?console.log(e):fs.renameSync(n,n+".Done")}])},callServiceManager:function(e,o,t){var i={type:"callServiceManager"},n=e.body,a=e.session.user,r=n.assetId,s=n.params;if(r){var u={aid:a.aid?a.aid:a,assetId:r};this._platform.runModule("asset","getAssetDetailByAssetIdAtPlatform",[u,function(e,t){if(e)i.error=e,i.status="0",o.json(i);else{var n="AC08"==t.categoryId?"Rest":"Soap",a=t.configureInfo;(new webServiceManager).callService({serviceType:n,serviceConfigInfo:a,params:s},function(e,t){e?(i.error=e,i.status="0",o.json(i)):o.json(JSON.parse(t))})}}])}else i.error="Empty assetId!",i.status="0",o.json(i)},testCallService:function(e,n,t){var a=e.body,o=a.params;(new webServiceManager).callService({serviceType:"Rest",serviceConfigInfo:{host:a.host,port:a.port,path:a.path,method:a.method,http_type:a.http_type},params:o||""},function(e,t){e?n.json({error:e}):n.json({data:t})})},keysort:function(n,a){return function(e,t){return a?~~(e[n]<t[n]):~~(e[n]>t[n])}},jsonSort:function(e,n,t){return e.length<2||!n||"object"!=typeof e[0]||("number"==typeof e[0][n]&&e.sort(function(e,t){return e[n]-t[n]}),"string"==typeof e[0][n]&&e.sort(function(e,t){return e[n].localeCompare(t[n])}),t&&e.reverse()),e},getSocketKeyManager:function(e,t,n){var a=e.body,o="",i=a.params.orderlist;if(i){this._initAcquisition();for(var r=[],s=0;s<i.length;s++){var u=i[s].split("_"),l=u[0],d=u[1];if(l&&d)o=l+"_"+encodeURIComponent(d).replace(/%/g,""),r.push(o),this.callAcquisitionSocket(l,d,o)}a.result={reqCommandList:r},a.status=1,t.json(a)}else t.json({type:"getSocketKeyManager",status:"0"})},callAcquisitionSocket:function(e,t,n){var a={id:n,type:1,property:t,bos:[e],isSendObj:!0};this._platform.runModule("acquisition","subscribeOrderWithCollectPropertyFilter",[a])},_initAcquisition:function(e){if(acquisitionInstance)return acquisitionInstance;var t={type:"xml",xmlFilePath:__dirname+"/acquisition.xml"};return acquisitionInstance=this._platform.runModule("acquisition","createAcquisition",[t])},_getSocketKey:function(e){return{action:{messageKey:"TEST_WEBSOCKET",type:"subscribe"}}},_run:function(){var e={messageKey:"TEST_WEBSOCKET",content:{results:{}}};setInterval(function(){EventBus.fireEvent("sendSocketMail",JSON.stringify(e),function(){})},3e3)},readFileList:function(a,o){var i=this;fs.readdirSync(a).forEach(function(e,t){if(fs.statSync(a+e).isDirectory())i.readFileList(a+e+"/",o);else{var n={};n.path=a,n.filename=e,o.push(n)}})},readFile:function(){var e=[];this.readFileList(__dirname+"/",e),console.log(e)}}),Business_Modules.Controller.Module=ControllerModule,Business_Modules.DatabaseConfig={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel"),DBConfig={db_id:{type:Sequelize.STRING,allowNull:!1,primaryKey:!0},config_name:{type:Sequelize.STRING,unique:!0},db_type:{type:Sequelize.STRING,allowNull:!1},host:{type:Sequelize.STRING,allowNull:!1},user:{type:Sequelize.STRING,allowNull:!1},pwd:{type:Sequelize.STRING,allowNull:!1},port:{type:Sequelize.STRING},database:{type:Sequelize.STRING},create_man:{type:Sequelize.STRING},create_time:{type:Sequelize.STRING},use_in:{type:Sequelize.STRING}};sequelizeModel&&sequelizeModel.registerModel("DBConfig","db_config",DBConfig),Business_Modules.DatabaseConfig.Model=sequelizeModel;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,Consts=fw.Framework.Consts,ErrorCode=Consts.ErrorCode,ActionStatus=Consts.ActionStatus,Module=fw.Framework.Module,RTDataModule=fw.Framework.RTDataModule,seqModels=utilities.loadSingleInstance("sequelizeModel"),MySQL=seqModels.mysqlAccess,EventBus=utilities.loadSingleInstance("EventBus"),mysql=fw.Framework.MySQL,mssql=fw.Framework.MSSQL,DBConfigMysqlMethod=function(){utilities.callSuper(DBConfigMysqlMethod,this,arguments),this._name="DBConfigMysqlMethod"};utilities.extend(DBConfigMysqlMethod,RTDataModule,{runningOnPlatform:function(e){utilities.invokeSuper(DBConfigMysqlMethod,"runningOnPlatform",this,[e])},addDBConfig:function(e,t){var n=e.data;if(n){var a=utilities.getGUID(12,32),o=e.user;delete e.user,n.dbId=a,n.createTime=utilities.formatDate(new Date,"yyyy-MM-dd hh:mm:ss"),n.createMan=o.aid;var i=this._translateDBConfigAttributes(n);seqModels.insert("DBConfig",i,function(e){t(null,e)},function(e){t(e)})}else t("Empty Values")},deleteDBConfigById:function(e,t){var n=e.data.dbId;n?seqModels.delete("DBConfig",{db_id:n},function(e){t(null,e)},function(e){t(e)}):t("Empty dbID!")},updateDBConfigById:function(e,t){var n=(a=e.data).dbId;delete a.dbId;var a=this._translateDBConfigAttributes(a);n?seqModels.update("DBConfig",a,{db_id:n},function(e){t(null,e)},function(e){t(e)}):t("Empty dbId")},getDBConfigList:function(e,o){var t=e.data,n={},a=" select db_id as dbId, config_name as configName, db_type as dbType,  create_man as createMan, create_time as createTime, host, user, port, pwd, db_configs.database  from db_configs where 1=1 ";t&&(t.dbId&&(a+=" and db_id like :DBID ",n.DBID="'%"+t.dbId+"%'"),t.configName&&(a+=" and config_name like :DBNAME ",n.DBNAME="'%"+t.configName+"%'"),t.dbType&&(a+=" and db_type like :DBTYPE ",n.DBTYPE="'%"+t.dbType+"%'"),t.createMan&&(a+="and create_man like :MAN ",n.MAN="'%"+t.createMan+"%'"),t.useIn&&(a+=" and use_id =:USEID ",n.USEID=t.useIn)),seqModels.queryFromSql(a,n,function(e){for(var t=[],n=0;n<e.length;n++){var a=e[n];t.push(a)}o(null,t)},function(e){o(e)})},getDBConfigDetailById:function(e,n){var t=e.data.dbId;t?seqModels.query("db_configs",{where:{db_id:t}},function(e){var t=e[0].dataValues;n(null,self._translateDBConfigAttributes(t))},function(e){n(e)}):n("Empty dbId!")},_instanceConnection:function(e){var t={};if(e){var n=e.dbType?e.dbType:e.db_type,a={host:e.host,user:e.user,port:e.port,password:e.pwd,database:e.database};return"mysql"===n?t=mysql:"mssql"===n&&(t=mssql),new t(a)}},testDBConfigCorrect:function(e,n){var a=this,t=e.data,o=t.configName,i={};o?seqModels.query("DBConfig",{where:{config_name:o}},function(e){var t=e[0].dataValues;t&&(i=a._instanceConnection(t)),i.query("show tables",{},function(e,t){e?n("连接失败！errno="+e.errno):n(null,"连接成功！"),i.release()})}):(i=a._instanceConnection(t)).query("show tables",{},function(e,t){e?n("连接失败！errno="+e.errno):n(null,"连接成功！"),i.release()})},queryWithSqlFromDB:function(e,o){var i=this,t=e.data,r=t.querySql,n=t.configName,a=(t.queryParams&&t.queryParams,t.dbId);if(re=/update|delete|truncate|union|exec|insert|drop|'|"|;/i,re.test(r))o("存在非法字符!");else{var s={};n&&(s.config_name=n),a&&(s.db_id=a),seqModels.query("DBConfig",{where:s},function(e){var t=e[0].dataValues;if(t){var n=i._instanceConnection(t),a=i._registerSql(r);n.query(a.sql,a.params,function(e,t){e?(n.release(function(e){}),o(e)):(n.release(function(e){}),o(null,t))})}},function(e){o(e)})}},_translateDBConfigAttributes:function(e){if(e){var t={};return e.db_id&&(t.dbId=e.db_id),e.dbId&&(t.db_id=e.dbId),e.config_name&&(t.configName=e.config_name),e.configName&&(t.config_name=e.configName),e.db_type&&(t.dbType=e.db_type),e.dbType&&(t.db_type=e.dbType),e.create_man&&(t.createMan=e.create_man),e.createMan&&(t.create_man=e.createMan),e.create_time&&(t.createTime=e.create_time),e.createTime&&(t.create_time=e.createTime),e.host&&(t.host=e.host),e.user&&(t.user=e.user),e.pwd&&(t.pwd=e.pwd),e.port&&(t.port=e.port),e.database&&(t.database=e.database),e.use_in&&(t.useIn=e.use_in),e.useIn&&(t.use_in=e.useIn),t}},_registerSql:function(e){if(e){var t={};return-1!=e.indexOf(":NEW_DATE")&&(t.NEW_DATE=utilities.formatDate(new Date,"yyyy-MM-dd hh:mm:ss")),{sql:e,params:t}}}}),Business_Modules.DatabaseConfig.DBConfigMysqlMethod=DBConfigMysqlMethod;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,ActionStatus=Consts.ActionStatus,ErrorCode=Consts.ErrorCode,Module=fw.Framework.Module,EventBus=utilities.loadSingleInstance("EventBus"),RTData=fw.Framework.RTData,httpAccess=fw.Framework.HttpAccess,databaseConfig_MysqlMethod=Business_Modules.DatabaseConfig.DBConfigMysqlMethod,DBConfigModule=function(){utilities.callSuper(DBConfigModule,this,arguments),this._name="DBConfigModule",this.databaseConfig_MysqlMethod=new databaseConfig_MysqlMethod};utilities.extend(DBConfigModule,RTDataModule,{getExports:function(){return["addDBConfigManager","deleteDBConfigByIdManager","updateDBConfigByIdManager","getDBConfigListManager","getDBConfigDetailByIdManager","testDBConfigCorrectManager","queryFromDBManager"]},addDBConfigManager:function(e,o,t){var i={type:"addDBConfigManager"},n=e.body,r=this,a=n.token;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r.databaseConfig_MysqlMethod.addDBConfig(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"addDBConfigManager",content:JSON.stringify({module:"dbConfig",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"addDBConfigManager",content:JSON.stringify({module:"dbConfig"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},deleteDBConfigByIdManager:function(e,o,t){var i={type:"deleteDBConfigByIdManager"},n=e.body,r=this,a=n.token;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r.databaseConfig_MysqlMethod.deleteDBConfigById(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"deleteDBConfigByIdManager",content:JSON.stringify({module:"dbConfig",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"deleteDBConfigByIdManager",content:JSON.stringify({module:"dbConfig"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},updateDBConfigByIdManager:function(e,o,t){var i={type:"updateDBConfigByIdManager"},n=e.body,r=this,a=n.token;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r.databaseConfig_MysqlMethod.updateDBConfigById(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"updateDBConfigByIdManager",content:JSON.stringify({module:"dbConfig",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"updateDBConfigByIdManager",content:JSON.stringify({module:"dbConfig"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},getDBConfigListManager:function(e,n,t){var a={type:"getDBConfigListManager"},o=e.body,i=this,r=o.token;i._platform.runModule("auth","getTokenByKey",[r,function(e,t){if(!t)return a.status=ActionStatus.F,a.error="No Token!",void n.json(a);o.user={aid:t.user};i.databaseConfig_MysqlMethod.getDBConfigList(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}])},getDBConfigDetailByIdManager:function(e,n,t){var a={type:"getDBConfigDetailManager"},o=e.body,i=this,r=o.token;i._platform.runModule("auth","getTokenByKey",[r,function(e,t){if(!t)return a.status=ActionStatus.F,a.error="No Token!",void n.json(a);o.user={aid:t.user};i.databaseConfig_MysqlMethod.getDBConfigDetailById(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}])},testDBConfigCorrectManager:function(e,n,t){var a={type:"testDBConfigCorrectManager"},o=e.body,i=this,r=o.token;i._platform.runModule("auth","getTokenByKey",[r,function(e,t){if(!t)return a.status=ActionStatus.F,a.error="No Token!",void n.json(a);o.user={aid:t.user};i.databaseConfig_MysqlMethod.testDBConfigCorrect(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}])},queryFromDBManager:function(e,n,t){var a={type:"queryFromDBManager"},o=e.body,i=this,r=o.token;i._platform.runModule("auth","getTokenByKey",[r,function(e,t){if(!t)return a.status=ActionStatus.F,a.error="No Token!",void n.json(a);o.user={aid:t.user};i.databaseConfig_MysqlMethod.queryWithSqlFromDB(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}])}}),Business_Modules.DatabaseConfig.Module=DBConfigModule,Business_Modules.Diagram={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel"),Project={pro_id:{type:Sequelize.STRING,allowNull:!1,primaryKey:!0},pro_name:{type:Sequelize.STRING,allowNull:!1},pro_type:{type:Sequelize.STRING,allowNull:!1},pro_customer:{type:Sequelize.STRING},create_man:{type:Sequelize.STRING},create_time:{type:Sequelize.DATE},status:{type:Sequelize.STRING},description:{type:Sequelize.TEXT},pro_model_id:{type:Sequelize.STRING},logic_enginee_json:{type:Sequelize.BLOB},app_enginee_json:{type:Sequelize.BLOB}},Diagram={diagram_id:{type:Sequelize.STRING,allowNull:!1,primaryKey:!0},diagram_name:{type:Sequelize.STRING,allowNull:!1},is_maindiagram:{type:Sequelize.BOOLEAN,defaultValue:!1},pro_id:{type:Sequelize.STRING},diagram_type:{type:Sequelize.STRING},status:{type:Sequelize.STRING},create_man:{type:Sequelize.STRING},create_time:{type:Sequelize.DATE},diagram_json:{type:Sequelize.BLOB},description:{type:Sequelize.TEXT}},ProUsers={pro_id:{type:Sequelize.STRING},aid:{type:Sequelize.STRING,allowNull:!1},position:{type:Sequelize.STRING},permission:{type:Sequelize.STRING},add_time:{type:Sequelize.DATE},description:{type:Sequelize.TEXT}};sequelizeModel&&(sequelizeModel.registerModel("Project","project",Project),sequelizeModel.registerModel("Diagram","diagram",Diagram),sequelizeModel.registerModel("ProUsers","pro_users",ProUsers)),Business_Modules.Diagram.Model=sequelizeModel;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,Consts=fw.Framework.Consts,ErrorCode=Consts.ErrorCode,ActionStatus=Consts.ActionStatus,Module=fw.Framework.Module,RTDataModule=fw.Framework.RTDataModule,seqModels=utilities.loadSingleInstance("sequelizeModel"),MySQL=seqModels.mysqlAccess,EventBus=utilities.loadSingleInstance("EventBus"),DiagramMysqlMethod=function(){utilities.callSuper(DiagramMysqlMethod,this,arguments),this._name="DiagramMysqlMethod"};utilities.extend(DiagramMysqlMethod,RTDataModule,{runningOnPlatform:function(e){utilities.invokeSuper(DiagramMysqlMethod,"runningOnPlatform",this,[e])},addProject:function(e,n){var t=e.data;if(t){var a=utilities.getGUID(12,32),o=e.user;t.proId=a,t.createTime=utilities.formatDate(new Date,"yyyy-MM-dd hh:mm:ss"),t.createMan=o.aid,t.status="0";var i=this._translateProjectAttributes(t);this._projectChecker(i,function(e,t){e?n(e):seqModels.insert("Project",i,function(e){n(null,e)},function(e){n(e)})})}else n("Empty Values")},_projectChecker:function(e,n){this._isRepeatProjectNameInPro({createMan:e.create_man,proName:e.pro_name},function(e,t){e?n(e):t?n("项目名称已存在，请重新命名！"):n(null,!0)})},_isRepeatProjectNameInPro:function(e,n){var t=e.proName,a=e.createMan;if(t){seqModels.queryFromSql(" select count(1) as num from projects where create_man=:CREATEMAN and pro_name=:PRONAME and status='0' ",{PRONAME:t,CREATEMAN:a},function(e){var t=e[0].num;n(null,1<=t)},function(e){n(e)})}},copyProjectFromProModel:function(n,i){var r=this,a=n.data;a&&a.proModelId&&seqModels.query("Project",{where:{pro_id:a.proModelId}},function(e){var t=e[0].dataValues;t&&(a.appEngineeJson=t.app_enginee_json,a.logicEngineeJson=t.logic_enginee_json,r.addProject({data:a,user:n.user},function(e,t){if(e)i(e);else if(t){var n="",a=t.dataValues,o=a.pro_model_id;n+=" INSERT INTO  diagrams(diagram_id, diagram_name, is_maindiagram, pro_id, diagram_type, status,  create_man, create_time, diagram_json, description)  SELECT substring(MD5(RAND()),1,12) as diagram_id, diagram_name, is_maindiagram,  '"+a.pro_id+"' as pro_id, diagram_type, status, create_man,  NOW() as create_time, diagram_json, description  FROM diagrams where pro_id='"+o+"'; ",seqModels.insertFromSql(n,{},function(e){i(null,r._translateProjectAttributes(a))},function(e){i(e)})}}))},function(e){i(e)})},addDiagram:function(e,n){var t=e.data;if(t){var a=utilities.getGUID(12,32),o=e.user;t.diagramId=a,t.createTime=utilities.formatDate(new Date,"yyyy-MM-dd hh:mm:ss"),t.status="0",t.createMan=o.aid;var i=this._translateDiagramAttributes(t);this._diagramChecker(i,function(e,t){e?n(e):seqModels.insert("Diagram",i,function(e){n(null,e)},function(e){n(e)})})}else n("Empty Values")},_diagramChecker:function(n,a){var o=this;o._isRepeatDiagramNameInPro({proId:n.pro_id,diagramName:n.diagram_name},function(e,t){e?a(e):t?a("图纸名重复！"):"1"===n.is_maindiagram||1===n.is_maindiagram||"true"===n.is_maindiagram?o.isExistsMainDiagram({data:{proId:n.pro_id}},function(e,t){e?a(e):t?a("该项目已存在主图纸！"):a(null,!0)}):a(null,!0)})},_isRepeatDiagramNameInPro:function(e,n){var t=e.proId,a=e.diagramName;if(t&&a){seqModels.queryFromSql(" select count(1) as num from diagrams where pro_id=:PROID and diagram_name=:DIAGRAMNAME and status='0' ",{PROID:t,DIAGRAMNAME:a},function(e){var t=e[0].num;n(null,1<=t)},function(e){n(e)})}},isExistsMainDiagram:function(e,n){var t=e.data.proId;if(t){seqModels.queryFromSql(" SELECT count(1) as num from diagrams where pro_id=:PROID and is_maindiagram=true and status='0' ",{PROID:t},function(e){var t=e[0].num;n(null,1<=t)},function(e){n(e)})}else n("Empty ProId!")},getProjectList:function(e,o){var t=e.data,n=e.user,a={},i=" select p.pro_id as proId, p.pro_name as proName,  p.pro_type as proType, p.pro_customer as proCustomer, p.description,  p.create_man as createMan, p.create_time as createTime, p.logic_enginee_json as logicEngineeJson,  p.app_enginee_json as appEngineeJson  from projects p  LEFT JOIN pro_users u ON p.pro_id=u.pro_id  where (u.aid='"+n.aid+"' OR p.pro_type='Public' OR p.create_man='"+n.aid+"')  and p.status<>'-1' ";t&&(t.proId&&(i+=" and p.pro_id=:PROID ",a.PROID=t.proId),t.proName&&(i+=" and p.pro_name like :PRONAME ",a.PRONAME="'%"+t.proName+"%'"),t.proType&&(i+=" and p.pro_type=:PROTYPE ",a.PROTYPE=t.proType),t.description&&(i+=" and p.description like :DESC ",a.DESC="'%"+t.description+"%'"),t.createMan&&(i+=" and p.create_man=:CREATEMAN ",a.CREATEMAN=t.createMan)),i+=" order by p.pro_name ",seqModels.queryFromSql(i,a,function(e){for(var t=[],n=0;n<e.length;n++){var a=e[n];a.appEngineeJson&&(a.appEngineeJson=a.appEngineeJson.toString("utf-8")),a.logicEngineeJson&&(a.logicEngineeJson=a.logicEngineeJson.toString("utf-8")),t.push(a)}o(null,t)},function(e){o(e)})},getDiagramList:function(e,o){var t=e.data,n={},a=e.user,i=" select d.diagram_id as diagramId, d.diagram_name as diagramName,d.is_maindiagram as isMainDiagram,  d.diagram_type as diagramType, d.create_time as createTime, d.create_man as createMan,  d.diagram_json as diagramJson, d.pro_id as proId, d.description  from diagrams d  LEFT JOIN pro_users u On u.pro_id=d.pro_id  where (d.create_man='"+a.aid+"' OR d.diagram_type='Public' OR u.aid='"+a.aid+"')  and status<>'-1' ";t&&(t.proId&&(i+=" and d.pro_id=:PROID ",n.PROID=t.proId),t.diagramId&&(i+=" and d.diagram_id=:DIAGRAMID ",n.DIAGRAMID=t.diagramId),t.diagramName&&(i+=" and d.diagram_name=:NAME ",n.NAME=t.diagramName),t.diagramType&&(i+=" and d.diagram_type=:TYPE ",n.TYPE=t.diagramType),t.description&&(i+=" and d.description like :DESC ",n.DESC="'%"+t.description+"%'"),t.createMan&&(i+=" and d.create_man=:CREATEMAN ",n.CREATEMAN=t.createMan)),i+=" order by d.diagram_name ",seqModels.queryFromSql(i,n,function(e){for(var t=[],n=0;n<e.length;n++){var a=e[n];a.diagramJson=a.diagramJson.toString("utf-8"),t.push(a)}o(null,t)},function(e){o(e)})},getProjectDetail:function(e,n){var a=this,t=e.data.proId;t?seqModels.query("Project",{where:{pro_id:t}},function(e){var t=e[0].dataValues;t.logic_enginee_json&&(t.logic_enginee_json=t.logic_enginee_json.toString("utf-8")),t.app_enginee_json&&(t.app_enginee_json=t.app_enginee_json.toString("utf-8")),n(null,a._translateProjectAttributes(t))},function(e){n(e)}):n("Empty proId")},getDiagramDetail:function(e,n){var a=this,t=e.data.diagramId;t?seqModels.queryFromSql("select d.*,p.logic_enginee_json,p.app_enginee_json from diagrams d,projects p where d.diagram_id=:diagram_id and d.pro_id=p.pro_id",{diagram_id:t},function(e){var t=e[0];t.diagram_json=t.diagram_json?t.diagram_json.toString("utf-8"):"",t.logic_enginee_json=t.logic_enginee_json?t.logic_enginee_json.toString("utf-8"):"",t.app_enginee_json=t.app_enginee_json?t.app_enginee_json.toString("utf-8"):"",n(null,a._translateDiagramAttributes(t))},function(e){n(e)}):n("Empty diagramId")},getMainDiagram:function(e,n){var a=this,t=e.data.proId;t?seqModels.query("Diagram",{where:{pro_id:t,is_maindiagram:!0}},function(e){var t=e[0].dataValues;t.diagram_json=t.diagram_json.toString("utf-8"),n(null,a._translateDiagramAttributes(t))},function(e){n(e)}):n("Empty proId")},updateProjectById:function(e,t){var n=(a=e.data).proId;delete a.proId;var a=this._translateProjectAttributes(a);n?seqModels.update("Project",a,{pro_id:n},function(e){t(null,e)},function(e){t(e)}):t("Empty proId")},updateDiagramById:function(e,t){var n=(a=e.data).diagramId;delete a.diagramId;var a=this._translateDiagramAttributes(a);n?seqModels.update("Diagram",a,{diagram_id:n},function(e){t(null,e)},function(e){t(e)}):t("Empty diagramId")},deleteProjectById:function(e,t){var n=e.data.proId;n?seqModels.seq.transaction(function(e){return seqModels.updateWithTrans("Project",{status:"-1"},{pro_id:n},e).then(function(){return seqModels.updateWithTrans("Diagram",{status:"-1"},{pro_id:n},e).then(function(){return seqModels.updateWithTrans("Enginee",{status:"-1"},{pro_id:n},e)})})}).then(function(e){t(null,1)}).catch(function(e){t(e)}):t("Empty proId")},deleteDiagramById:function(e,t){var n=e.data.diagramId;n?this.updateDiagramById({data:{diagramId:n,status:"-1"}},function(e){t(null,e)},function(e){t(e)}):t("Empty diagramId!")},addUserToPro:function(e,t){var n=e.data,a=n.proId,o=n.aid;if(a&&o){n.addTime=utilities.formatDate(new Date,"yyyy-MM-dd hh:mm:ss");this._translateUserAttributes(n);seqModels.insert("ProUsers",n,function(e){t(null,e)},function(e){t(e)})}else t("Empty aid OR proId")},removeUserFromPro:function(e,t){var n=e.data,a=n.aid,o=n.proId;o&&a?seqModels.delete("ProUsers",{aid:a,pro_id:o},function(e){t(null,e)},function(e){t(e)}):t("Empty aid OR proId")},_translateProjectAttributes:function(e){if(e){var t={};return e.proId&&(t.pro_id=e.proId),e.pro_id&&(t.proId=e.pro_id),e.proName&&(t.pro_name=e.proName),e.pro_name&&(t.proName=e.pro_name),e.proType&&(t.pro_type=e.proType),e.pro_type&&(t.proType=e.pro_type),e.pro_customer&&(t.proCustomer=e.pro_customer),e.proCustomer&&(t.pro_customer=e.proCustomer),e.status&&(t.status=e.status),e.description&&(t.description=e.description),e.create_time&&(t.createTime=e.create_time),e.createTime&&(t.create_time=e.createTime),e.createMan&&(t.create_man=e.createMan),e.create_man&&(t.createMan=e.create_man),e.proModelId&&(t.pro_model_id=e.proModelId),e.pro_model_id&&(t.proModelId=e.pro_model_id),e.logicEngineeJson&&(t.logic_enginee_json=e.logicEngineeJson),e.logic_enginee_json&&(t.logicEngineeJson=e.logic_enginee_json),e.appEngineeJson&&(t.app_enginee_json=e.appEngineeJson),e.app_enginee_json&&(t.appEngineeJson=e.app_enginee_json),t}},_translateDiagramAttributes:function(e){if(e){var t={};return e.diagramId&&(t.diagram_id=e.diagramId),e.diagram_id&&(t.diagramId=e.diagram_id),e.is_maindiagram&&(t.isMainDiagram=e.is_maindiagram),e.isMainDiagram&&(t.is_maindiagram=e.isMainDiagram),e.diagram_name&&(t.diagramName=e.diagram_name),e.diagramName&&(t.diagram_name=e.diagramName),e.diagram_type&&(t.diagramType=e.diagram_type),e.diagramType&&(t.diagram_type=e.diagramType),e.diagram_json&&(t.diagramJson=e.diagram_json),e.diagramJson&&(t.diagram_json=e.diagramJson),e.logic_enginee_json&&(t.logicEngineeJson=e.logic_enginee_json),e.app_enginee_json&&(t.appEngineeJson=e.app_enginee_json),e.create_time&&(t.createTime=e.create_time),e.createTime&&(t.create_time=e.createTime),e.description&&(t.description=e.description),e.status&&(t.status=e.status),e.proId&&(t.pro_id=e.proId),e.pro_id&&(t.proId=e.pro_id),e.createMan&&(t.create_man=e.createMan),e.create_man&&(t.createMan=e.create_man),t}},_translateUserAttributes:function(e){if(e){var t={};return e.aid&&(t.aid=e.aid),e.proId&&(t.pro_id=e.proId),e.pro_id&&(t.proId=e.pro_id),e.position&&(t.position=e.position),e.permission&&(t.permission=e.permission),e.description&&(t.description=e.description),e.add_time&&(t.addTime=e.add_time),e.addTime&&(t.add_time=e.addTime),t}}}),Business_Modules.Diagram.DiagramMysqlMethod=DiagramMysqlMethod;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,ActionStatus=Consts.ActionStatus,ErrorCode=Consts.ErrorCode,Module=fw.Framework.Module,EventBus=utilities.loadSingleInstance("EventBus"),RTData=fw.Framework.RTData,httpAccess=fw.Framework.HttpAccess,DiagramMysqlMethod=Business_Modules.Diagram.DiagramMysqlMethod,DiagramModule=function(){utilities.callSuper(DiagramModule,this,arguments),this._name="DiagramModule",this._diagramMysqlMethod=new DiagramMysqlMethod};utilities.extend(DiagramModule,RTDataModule,{getExports:function(){return["addProjectManager","addDiagramManager","getProjectListManager","getProjectDetailManager","getDiagramListManager","getDiagramDetailManager","getMainDiagramManager","updateProjectByIdManager","updateDiagramByIdManager","deleteProjectByIdManager","deleteDiagramByIdManager","addUserToProManager","removeUserFromProManager","isExistsMainDiagramManager","copyProjectFromProModelManager"]},addProjectManager:function(e,o,t){var i={type:"addProjectManager"},n=e.body,a=n.token,r=this;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r._diagramMysqlMethod.addProject(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"addProjectManager",content:JSON.stringify({module:"diagram",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else i.status=ActionStatus.S,i.result={data:t},o.json(i),n={logid:utilities.getGUID(20),type:"addProjectManager",content:JSON.stringify({module:"diagram"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n))})}])},copyProjectFromProModelManager:function(e,o,t){var i={type:"copyProjectFromProModelManager"},n=e.body,a=n.token,r=this;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r._diagramMysqlMethod.copyProjectFromProModel(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"copyProjectFromProModelManager",content:JSON.stringify({module:"diagram",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"copyProjectFromProModelManager",content:JSON.stringify({module:"diagram"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},addDiagramManager:function(e,o,t){var i={type:"addDiagramManager"},n=e.body,a=n.token,r=this;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r._diagramMysqlMethod.addDiagram(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"addDiagramManager",content:JSON.stringify({module:"diagram",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"addDiagramManager",content:JSON.stringify({module:"diagram"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},isExistsMainDiagramManager:function(e,n,t){var a={type:"isExistsMainDiagramManager"},o=e.body,i=o.token,r=this;r._platform.runModule("auth","getTokenByKey",[i,function(e,t){if(!t)return a.status=ActionStatus.F,a.error="No Token!",void n.json(a);o.user={aid:t.user};r._diagramMysqlMethod.isExistsMainDiagram(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}])},getProjectListManager:function(e,n,t){var a={type:"getProjectListManager"},o=e.body,i=o.token,r=this;r._platform.runModule("auth","getTokenByKey",[i,function(e,t){if(!t)return a.status=ActionStatus.F,a.error="No Token!",void n.json(a);o.user={aid:t.user};r._diagramMysqlMethod.getProjectList(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}])},getProjectDetailManager:function(e,n,t){var a={type:"getProjectDetailManager"},o=e.body,i=o.token,r=this;r._platform.runModule("auth","getTokenByKey",[i,function(e,t){if(!t)return a.status=ActionStatus.F,a.error="No Token!",void n.json(a);o.user={aid:t.user};r._diagramMysqlMethod.getProjectDetail(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}])},getDiagramListManager:function(e,n,t){var a={type:"getDiagramListManager"},o=e.body,i=o.token,r=this;r._platform.runModule("auth","getTokenByKey",[i,function(e,t){if(!t)return a.status=ActionStatus.F,a.error="No Token!",void n.json(a);o.user={aid:t.user};r._diagramMysqlMethod.getDiagramList(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}])},getDiagramDetailManager:function(e,n,t){var a={type:"getDiagramDetailManager"},o=e.body;return this._diagramMysqlMethod.getDiagramDetail(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})},getMainDiagramManager:function(e,n,t){var a={type:"getMainDiagramManager"},o=e.body;return this._diagramMysqlMethod.getMainDiagram(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})},updateProjectByIdManager:function(e,o,t){var i={type:"updateProjectByIdManager"},n=e.body,a=n.token,r=this;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r._diagramMysqlMethod.updateProjectById(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"updateProjectByIdManager",content:JSON.stringify({module:"diagram",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"updateProjectByIdManager",content:JSON.stringify({module:"diagram"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},updateDiagramByIdManager:function(e,o,t){var i={type:"updateDiagramByIdManager"},n=e.body,a=n.token,r=this;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r._diagramMysqlMethod.updateDiagramById(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"updateDiagramByIdManager",content:JSON.stringify({module:"diagram",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"updateDiagramByIdManager",content:JSON.stringify({module:"diagram"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},deleteProjectByIdManager:function(e,o,t){var i={type:"deleteProjectByIdManager"},n=e.body,a=n.token,r=this;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r._diagramMysqlMethod.deleteProjectById(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"deleteProjectByIdManager",content:JSON.stringify({module:"diagram",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"deleteProjectByIdManager",content:JSON.stringify({module:"diagram"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},deleteDiagramByIdManager:function(e,o,t){var i={type:"deleteDiagramByIdManager"},n=e.body,a=n.token,r=this;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r._diagramMysqlMethod.deleteDiagramById(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"deleteDiagramByIdManager",content:JSON.stringify({module:"diagram",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"deleteDiagramByIdManager",content:JSON.stringify({module:"diagram"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},addUserToProManager:function(e,o,t){var i={type:"addUserToProManager"},n=e.body,a=n.token,r=this;r._platform.runModule("auth","getTokenByKey",[a,function(e,a){if(!a)return i.status=ActionStatus.F,i.error="No Token!",void o.json(i);n.user={aid:a.user};r._diagramMysqlMethod.addUserToPro(n,function(e,t){if(e){var n={logid:utilities.getGUID(20),type:"addUserToProManager",content:JSON.stringify({module:"diagram",error:e}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"FAIL"};EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.F,i.error=e,o.json(i)}else n={logid:utilities.getGUID(20),type:"addUserToProManager",content:JSON.stringify({module:"diagram"}),category:"0",operator:a.user?a.user:"",createtime:new Date,operatorip:a.ip?a.ip:"",result:"SUCCESS"},EventBus.fireEvent("log_addLogging",n),console.log(JSON.stringify(n)),i.status=ActionStatus.S,i.result={data:t},o.json(i)})}])},removeUserFromProManager:function(e,n,t){var a={type:"removeUserFromProManager"},o=e.body,i=o.token,r=this;r._platform.runModule("auth","getTokenByKey",[i,function(e,t){if(!t)return a.status=ActionStatus.F,a.error="No Token!",void n.json(a);o.user={aid:t.user};r._diagramMysqlMethod.removeUserFromPro(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}])}}),Business_Modules.Diagram.Module=DiagramModule,Business_Modules.DynamicEngine={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel"),Enginee={enginee_id:{type:Sequelize.STRING,allowNull:!1,primaryKey:!0},enginee_name:{type:Sequelize.STRING,allowNull:!1},enginee_function:{type:Sequelize.BLOB,allowNull:!1},enginee_type:{type:Sequelize.STRING},pro_id:{type:Sequelize.STRING},create_man:{type:Sequelize.STRING},create_time:{type:Sequelize.DATE},status:{type:Sequelize.INTEGER},description:{type:Sequelize.TEXT},type:{type:Sequelize.STRING}};sequelizeModel&&sequelizeModel.registerModel("Enginee","enginee",Enginee),Business_Modules.DynamicEngine.Model=sequelizeModel;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,Consts=fw.Framework.Consts,ErrorCode=Consts.ErrorCode,ActionStatus=Consts.ActionStatus,Module=fw.Framework.Module,RTDataModule=fw.Framework.RTDataModule,seqModels=utilities.loadSingleInstance("sequelizeModel"),MySQL=seqModels.mysqlAccess,EventBus=utilities.loadSingleInstance("EventBus"),EngineeMysqlMethod=function(){utilities.callSuper(EngineeMysqlMethod,this,arguments),this._name="EngineeMysqlMethod"};utilities.extend(EngineeMysqlMethod,RTDataModule,{runningOnPlatform:function(e){utilities.invokeSuper(EngineeMysqlMethod,"runningOnPlatform",this,[e])},addEnginee:function(e,t,n){var a=e.data;if(a){var o=this._transformDataToDatabase(a,t);this._isRepeatEngineNameInPro({proId:a.proId,engineeName:a.engineeName},function(e,t){e?n(e):t?n("名称重复！"):seqModels.insert("Enginee",o,function(e){n(null,e)},function(e){n(e)})})}else n("Empty Values")},_isRepeatEngineNameInPro:function(e,n){var t=e.proId,a=e.engineeName;if(t&&a){seqModels.queryFromSql(" select count(1) as num from enginees where pro_id=:PROID and enginee_name=:ENGINEE_NAME and status='0' ",{PROID:t,ENGINEE_NAME:a},function(e){var t=e[0].num;n(null,1<=t)},function(e){n(e)})}},_transformDataToDatabase:function(e,t){return{enginee_id:e.engineeId?e.engineeId:utilities.getGUID(12,32),enginee_name:e.engineeName?e.engineeName:null,enginee_function:e.engineeFunction?e.engineeFunction:null,enginee_type:e.engineeType?e.engineeType:null,pro_id:e.proId?e.proId:null,create_man:t.aid,create_time:utilities.formatDate(new Date,"yyyy-MM-dd hh:mm:ss"),status:0,description:e.description?e.description:null,type:e.type?e.type:"public"}},deleteEngineeByParams:function(e,t){var n=e.data;if(n){var a=this.getDatabaseSearchData(n);seqModels.update("Enginee",{status:-1},a,function(e){t(null,e)},function(e){t(e)})}else t("Empty Values")},getDatabaseSearchData:function(e){var t={};return e.engineeId&&(t.enginee_id=e.engineeId),e.engineeName&&(t.enginee_name=e.engineeName),e.engineeFunction&&(t.enginee_function=e.engineeFunction),e.createMan&&(t.create_man=e.createMan),e.createTime&&(t.create_time=e.createTime),e.status&&(t.status=e.status),e.description&&(t.description=e.description),e.type&&(t.type=e.type),e.engineeType&&(t.enginee_type=e.engineeType),e.proId&&(t.pro_id=e.proId),t},updateEngineeByParams:function(e,t){var n=e.data;if(n){var a=n.updateInfo,o=n.updateFactor,i=this.getDatabaseSearchData(a),r=this.getDatabaseSearchData(o);seqModels.update("Enginee",i,r,function(e){t(null,e)},function(e){t(e)})}else t("Empty Values")},getEngineeByParams:function(e,a){var t=e.data;if(t){var o=this,n=this.getDatabaseSearchFactor(t);seqModels.query("Enginee",{where:n},function(e){for(var t=[],n=0;n<e.length;n++)t[n]=o.getPageData(e[n].dataValues);a(null,t)},function(e){a(e)})}else a("Empty Values")},getDatabaseSearchFactor:function(e){var t={};return e.engineeId&&(t.enginee_id=e.engineeId),e.engineeName&&(t.enginee_name=e.engineeName),e.engineeFunction&&(t.enginee_function=e.engineeFunction),e.createMan&&(t.create_man=e.createMan),e.createTime&&(t.create_time=e.createTime),t.status=0,e.description&&(t.description={like:"%"+e.description+"%"}),e.type&&(t.type=e.type),e.engineeType&&(t.enginee_type=e.engineeType),e.proId&&(t.pro_id=e.proId),t},getPageData:function(e){return{engineeId:e.enginee_id?e.enginee_id:null,engineeName:e.enginee_name?e.enginee_name:null,engineeFunction:e.enginee_function?e.enginee_function.toString("utf-8"):null,createMan:e.create_man?e.create_man:null,createTime:e.create_time?e.create_time:null,status:e.status,description:e.description?e.description:null,type:e.type?e.type:null,engineeType:e.enginee_type?e.enginee_type:null,proId:e.pro_id?e.pro_id:null}}}),Business_Modules.DynamicEngine.EngineeMysqlMethod=EngineeMysqlMethod;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,ActionStatus=Consts.ActionStatus,ErrorCode=Consts.ErrorCode,Module=fw.Framework.Module,EventBus=utilities.loadSingleInstance("EventBus"),RTData=fw.Framework.RTData,httpAccess=fw.Framework.HttpAccess,EngineeMysqlMethod=Business_Modules.DynamicEngine.EngineeMysqlMethod,EngineeModule=function(){utilities.callSuper(EngineeModule,this,arguments),this._name="enginee",this._engineeMysqlMethod=new EngineeMysqlMethod};utilities.extend(EngineeModule,RTDataModule,{getExports:function(){return["addEngineeManager","deleteEngineeByParamsManager","updateEngineeByParamsManager","getEngineeByParamsManager"]},addEngineeManager:function(e,a,t){var o={type:"addEngineeManager"},n=e.body,i={},r=n.token,s=this._platform.runModule("auth","getTokenByKey",[r]);if(!s)return o.status=ActionStatus.F,o.error="No Token!",void a.json(o);i={aid:s.user};return this._engineeMysqlMethod.addEnginee(n,i,function(e,t){if(e)o.status=ActionStatus.F,o.error=e,a.json(o);else{var n={logType:"ADD",actionType:"addEngineeManager",operator:s.user};EventBus.fireEvent("AddLog",n),o.status=ActionStatus.S,o.result={data:t},a.json(o)}})},deleteEngineeByParamsManager:function(e,a,t){var o={type:"deleteEngineeByParamsManager"},n=e.body,i=n.token,r=this._platform.runModule("auth","getTokenByKey",[i]);if(!r)return o.status=ActionStatus.F,o.error="No Token!",void a.json(o);r.user;return this._engineeMysqlMethod.deleteEngineeByParams(n,function(e,t){if(e)o.status=ActionStatus.F,o.error=e,a.json(o);else{var n={logType:"DELETE",actionType:"deleteEngineeByParamsManager",operator:r.user};EventBus.fireEvent("AddLog",n),o.status=ActionStatus.S,o.result={data:t},a.json(o)}})},updateEngineeByParamsManager:function(e,a,t){var o={type:"updateEngineeByParamsManager"},i=e.body,n=i.token,r=this._platform.runModule("auth","getTokenByKey",[n]);if(!r)return o.status=ActionStatus.F,o.error="No Token!",void a.json(o);r.user;return this._engineeMysqlMethod.updateEngineeByParams(i,function(e,t){if(e)o.status=ActionStatus.F,o.error=e,a.json(o);else{var n={logType:"UPDATE",actionType:"updateEngineeByParamsManager",operator:r.user,updateContents:JSON.stringify(i.data)};EventBus.fireEvent("AddLog",n),o.status=ActionStatus.S,o.result={data:t},a.json(o)}})},getEngineeByParamsManager:function(e,n,t){var a={type:"getEngineeByParamsManager"},o=e.body;return this._engineeMysqlMethod.getEngineeByParams(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})}}),Business_Modules.DynamicEngine.Module=EngineeModule,Business_Modules.LangchaoBusiness={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel"),onLinePersonnel={pid:{type:Sequelize.STRING,allowNull:!1,primaryKey:!0},name:{type:Sequelize.STRING},location:{type:Sequelize.STRING},ontime:{type:Sequelize.STRING},docu:{type:Sequelize.STRING},post:{type:Sequelize.STRING}};sequelizeModel&&sequelizeModel.registerModel("onLinePersonnel","onlineper",onLinePersonnel),Business_Modules.LangchaoBusiness.Model=sequelizeModel;var fw=require("../../../libs/f"),ep=require("./langchaoData/ep"),themeData=ep.ThemeData,themeChengguanData=require("./langchaoData/chengguan"),utilities=fw.Framework.Utilities,Consts=fw.Framework.Consts,ErrorCode=Consts.ErrorCode,ActionStatus=Consts.ActionStatus,RTDataModule=fw.Framework.RTDataModule,seqModels=utilities.loadSingleInstance("sequelizeModel"),MySQL=seqModels.mysqlAccess,EventBus=utilities.loadSingleInstance("EventBus"),mysql=fw.Framework.MySQL,LangChaoMysqlMethod=function(){utilities.callSuper(LangChaoMysqlMethod,this,arguments),this._name="LangChaoMysqlMethod"};utilities.extend(LangChaoMysqlMethod,RTDataModule,{runningOnPlatform:function(e){utilities.invokeSuper(LangChaoMysqlMethod,"runningOnPlatform",this,[e])},getEPData:function(o){var n=this,i={};n.getRanking({rankType:"74",cityCode:"370100",startTime:"201801"},function(e,t){e?o(e):(i.Ranking_74=t,n.getRanking({rankType:"28",cityCode:"370100",startTime:"201801"},function(e,t){e?o(e):(i.Ranking_28=t,n.getRanking({rankType:"QXAirRanking"},function(e,t){if(e)o(e);else{i.Ranking_QX=t,i.Ranking_QX_AIQ=themeData.ep.QXAirAIQRanking;var n=themeData.ep.AEQuality,a=utilities.getRandomInt(0,9);i.AEQuality=n[a],i.Ranking_QXAirPollution=themeData.ep.QXAirPollutionRanking,i.Ranking_RoadAirPollution=themeData.ep.RoadAirPollutionRanking,i.RiverWaterQuality=themeData.ep.RiverWaterQuality,i.DrinkingWaterSource=themeData.ep.DrinkingWaterSource,o(null,i)}}))}))})},getRanking:function(e,t){var n=e.rankType,a=(e.dateType,e.cityCode),o=e.startTime,i=utilities.formatDate(new Date,"yyyyMM");if(!n||"28"!==n&&"74"!==n)if("QXAirRanking"===n)this.getQXRanking(e,t);else if("QXAirAIQRanking"===n)t(null,themeData.ep.QXAirAIQRanking);else if("AEQuality"===n){var r=themeData.ep.AEQuality,s=utilities.getRandomInt(0,9);t(null,r[s])}else"QXAirPollutionRanking"===n?t(null,themeData.ep.QXAirPollutionRanking):"RoadAirPollutionRanking"===n&&t(null,themeData.ep.RoadAirPollutionRanking);else{var u={},l="SELECT citycode, sortIndex, startTime from clt_citypaiming_histories  where 1=1  and cityGroupType=:RANKTYPE ";u.RANKTYPE=n,o&&(l+=" and startTime>=:STARTTIME ",u.STARTTIME=o),i&&(l+=" and startTime<=:ENDTIME ",u.ENDTIME=i),a&&(l+=" and citycode=:CITYCODE ",u.CITYCODE=a),l+=" order by startTime",seqModels.queryFromSql(l,u,function(e){t(null,e)},function(e){t(e)})}},getRiverQualityData:function(e,t){var n=e.dataType;if(n){if("RiverWaterQuality"===n)t(null,themeData.ep.RiverWaterQuality);else if("DrinkingWaterSource"===n){var a=utilities.getRandomInt(0,1);t(null,themeData.ep.DrinkingWaterSource[a].data)}}else t("no type")},getQXRanking:function(e,t){e.rankType;var n=e.startTime;n||(n=utilities.getBeforeDate(7).replace(/-/g,""));var a={};a.STARTTIME=n,seqModels.queryFromSql(" SELECT obj.code as citycode,obj.`index`,startTime,stationCode,pm10,pm25,@rownum := @rownum + 1 AS sortIndex  FROM     (SELECT * from clt_stapm_histories where startTime =:STARTTIME ORDER BY `index` DESC) AS obj,     (SELECT @rownum := 0) r ",a,function(e){t(null,e||null)},function(e){t(e)})},simulationJNAiqDate:function(e,a){seqModels.queryFromSql(" select * from clt_74city_histories where cityCode='370100' ",{},function(e){var t=e.length;if(0<t){var n=e[utilities.getRandomInt(0,t-1)];n.AIQ=utilities.getRandomInt(35,99),a(null,n)}else a(null,null)},function(e){a(e)})},getComplexData:function(e,t){var n=e.dataType,a=e.num;if(n)switch(n){case"Economic":t(null,themeData.complex.Economic);break;case"CityDevelopment":t(null,themeData.complex.CityDevelopment);break;case"TravelDevelopment":t(null,themeData.complex.TravelDevelopment);break;case"MedicalHygiene":t(null,themeData.complex.MedicalHygiene);break;case"CityWater":t(null,themeData.complex.CityWater);break;case"CulturalEducation":t(null,themeData.complex.CulturalEducation);break;case"IndustryInfo":t(null,this.get_Industry_hospital(a));break;case"padIndustryHospitalInfo":t(null,this.getPad_Industry_hospital());break;case"HospitalInfo":t(null,this.getHospitalInfo());break;case"All":t(null,this.getAllComplex(a));break;default:t("Invalid dataType")}},get_ChengGuanData:function(){return{GridPartsTheme:themeChengguanData.showThemeChengguanData(),VehicleTheme:themeChengguanData.showThemeVehicleData(),PersonTheme:themeChengguanData.showThemePersonData(),EventData:themeChengguanData.showEventData()}},get_Industry_hospital:function(e){return{industry:this.getIndustryInfo(e),allhospitals:this.getHospitalInfo(),hospitalIndex:themeData.complex.hospital}},getPad_Industry_hospital:function(){return{industry:this.getIndustryInfo(),hospitals:this._getPadHospital()}},_getPadHospital:function(){return themeData.complex.allhospitals},getAllComplex:function(e){var t=this.getIndustryInfo(e),n=this.getHospitalInfo();return themeData.complex.hospital=n,themeData.complex.companys=t,themeData.complex},getHospitalInfo:function(){for(var e=themeData.complex.allhospitals,t=0;t<e.length;t++){var n=e[t],a=n.patientNumber,o=n.treatmentCost,i=utilities.getRandomInt(0,100),r=utilities.getRandomInt(0,1e3);n.patientNumber=a?a+i:i,n.treatmentCost=o?o+r:r}return e},getIndustryInfo:function(num){if(!num)return themeData.complex.companys;var index=num;num>themeData.complex.industrialTypes.length-1&&(index=num%themeData.complex.industrialTypes.length);var str="this.get_"+themeData.complex.industrialTypes[index],data=eval(str+"()");return data},get_income:function(){for(var e={},t=[],n=themeData.complex.companys,a=themeData.complex.industrialTypes,o=0;o<n.length;o++){(e=n[o]).income=utilities.getRandom(1e3,1e4);for(var i=0;i<a.length;i++)"income"!=a[i]&&(e[a[i]]=null);t[o]=e}return t},get_increase_percent:function(){for(var e={},t=[],n=themeData.complex.companys,a=themeData.complex.industrialTypes,o=0;o<n.length;o++){(e=n[o]).increase_percent=utilities.getRandom(0,1);for(var i=0;i<a.length;i++)"increase_percent"!=a[i]&&(e[a[i]]=null);t[o]=e}return t},get_profit:function(){for(var e={},t=[],n=themeData.complex.companys,a=themeData.complex.industrialTypes,o=0;o<n.length;o++){(e=n[o]).profit=utilities.getRandom(1e3,1e4);for(var i=0;i<a.length;i++)"profit"!=a[i]&&(e[a[i]]=null);t[o]=e}return t},get_total_asset:function(){for(var e={},t=[],n=themeData.complex.companys,a=themeData.complex.industrialTypes,o=0;o<n.length;o++){(e=n[o]).total_asset=utilities.getRandom(1e4,1e5);for(var i=0;i<a.length;i++)"total_asset"!=a[i]&&(e[a[i]]=null);t[o]=e}return t},get_total_owe:function(){for(var e={},t=[],n=themeData.complex.companys,a=themeData.complex.industrialTypes,o=0;o<n.length;o++){(e=n[o]).total_owe=utilities.getRandom(1e3,1e4);for(var i=0;i<a.length;i++)"total_owe"!=a[i]&&(e[a[i]]=null);t[o]=e}return t},getCityManagementData:function(e,t){var n=e.dataType;if(n)switch(n){case"CityManage":t(null,this.get_ChengGuanData());break;case"Evaluation":var a=utilities.getRandomInt(0,4);t(null,themeData.cityManagement.Evaluation[a])}},getOnlinePersonnelByParams:function(e,o){var i=e.dataType;if(i){var t="",n={},a=new Date,r=utilities.formatDate(a,"hh");"OnlinePersonnelRatio"===i?(t=" SELECT count(1) as num ,docu,ontime,post  from onlinepers where ontime = :NOWDATETIME GROUP BY post  ",n.NOWDATETIME=r):"OnlineDocumentRatio"===i?(t=" SELECT count(1) as num,docu,ontime,post  from onlinepers where ontime =:NOWDATETIME  GROUP BY docu ",n.NOWDATETIME=r):"OnlinePersonnelTrend"===i&&(t="SELECT count(1) as num,ontime from onlinepers  GROUP BY ontime "),seqModels.queryFromSql(t,n,function(e){var t=e.length;if(0<t){if("OnlinePersonnelRatio"===i)for(var n=0;n<t;n++){var a=e[n];"0"===a.post&&(a.post="巡查人员"),"1"===a.post&&(a.post="管理人员"),"2"===a.post&&(a.post="作业人员")}o(null,e)}else o(null,"null")},function(e){})}},createOnLinePersonnel:function(){for(var e=0;e<24;e++){var t="";t=9<e?e+":00":"0"+e+":00";for(var n=["城市量化管理处","城管执法机动大队","静态交通管理执法大队","城乡环卫发展公司","城区综合管理大队","环境卫生管理处","园林绿化管理处"],a=utilities.getRandomInt(8,25),o=0;o<a;o++){var i="117."+utilities.getRandomInt(0,5800),r="36."+utilities.getRandomInt(3700,7800),s=utilities.getRandomInt(0,6),u={pid:utilities.getGUID(12,32),location:i+","+r,ontime:t,docu:n[s],post:utilities.getRandomInt(0,2)};seqModels.insert("onLinePersonnel",u,function(e){},function(e){console.log(e)})}}}}),Business_Modules.LangchaoBusiness.LangChaoMysqlMethod=LangChaoMysqlMethod;var fw=require("../../../libs/f"),c=require("../../config");utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,ActionStatus=Consts.ActionStatus,ErrorCode=Consts.ErrorCode,EventBus=utilities.loadSingleInstance("EventBus");var RTData=fw.Framework.RTData,httpAccess=fw.Framework.HttpAccess,LangChaoMysqlMethod=Business_Modules.LangchaoBusiness.LangChaoMysqlMethod,hb_FolwdataId="",zh_FolwdataId="",cg_FolwdataId="",CURRENT_WORKFLOW_ID="",CURRENT_FLOWDATA_ID="",ip=c.url,citytimerInterval=1e3,chengGuantimerInterval=1e3,testIndustryNum=-1,langchaoModule=function(){utilities.callSuper(langchaoModule,this,arguments),this._name="langchaoModule",this._langChaoMysqlMethod=new LangChaoMysqlMethod;this.focusedEventArray=[],this.messageSendType="websocket"};utilities.extend(langchaoModule,RTDataModule,{getExports:function(){return["getRankingManager","getRiverQualityDataManager","getEconomicManager","getCityManagementDataManager","getEPDataManager","runWorkFlowManager","stopIntervalTimerManager","controlCurrentWorkFlowManager","getTaxiAndRoadDataManager","getIndustryInfoManager","getRiverDataManager","transformThemeManager","getRRoadAirPollutionDataWithCltManager","getIndustryInfoByButton","getAllTaxiManager","getCurrentWorkflowManager","testWebServerData"]},runningOnPlatform:function(){utilities.invokeSuper(langchaoModule,"runningOnPlatform",this,arguments);this._start_CG_timer()},testWebServerData:function(e,t,n){var a={type:"testWebServerData"};a.status=ActionStatus.S,a.result={},t.json(a)},listenWebSocket:function(){var i=this;"websocket"===i.messageSendType&&EventBus.fireEvent("receiveSocketMail",function(e){e.on("text",function(e){var t=JSON.parse(e),n=t.messageKey,a=t.content;switch(n){case"runTheme":i._runWorkFlowWithCommand(a);break;case"pauseTheme":i._pauseWorkFlow();break;case"continueTheme":i._continueWorkFlow(a);break;case"endEvent":var o=JSON.parse(a);i._runWorkFlowWithCommand(o)}})})},getCurrentWorkflowManager:function(e,t,n){var a={type:"getCurrentWorkflowManager"};e.body;CURRENT_WORKFLOW_ID?(a.status=ActionStatus.S,a.result="Success",a.data={ThemeName:"EProtectionTheme"===CURRENT_WORKFLOW_ID?"HB_Theme":CURRENT_WORKFLOW_ID}):(a.status=ActionStatus.F,a.error="No WorkFlow!"),t.json(a)},transformThemeManager:function(e,t,n){var a={type:"transformThemeManager"},o=e.body.themeName;o?(this._fireWebSocketEvent({messageKey:"transformTheme",data:{themeName:o}}),a.status=ActionStatus.S,a.result="Success"):(a.status=ActionStatus.F,a.error="Empty themeName!"),t.json(a)},getRiverDataManager:function(e,u,t){var l={type:"getRiverDataManager"},d=e.body.riverNum;return this._platform.runModule("acquisition","getRiverPointDataWithClt",[{categoryId:"AC20",aid:"robin"},function(e,t){if(e)l.status=ActionStatus.F,l.error=e,u.json(l);else{for(var n={},a=[],o=0;o<t.length;o++){var i=t[o],r={},s={"marker-color":"#034e7d","marker-size":"medium","marker-symbol":""};s.name=i.name,s.NH3_N=i.NH3_N,s.CODCr=i.CODCr,s.rtsp="",s.webUrl="http://"+ip+"/video/river0"+(o+1)+".mp4",r.properties=s,r.type="Feature",r.geometry={type:"Point",coordinates:[i.longitude,i.latitude]},a.push(r)}d?(n.features=a.splice(0,d),n.dataType="ScanRiver"):(n.features=a,n.dataType="AllRiver"),n.type="FeatureCollection",l.status=ActionStatus.S,l.result={data:n},u.json(l)}}])},getAllTaxiManager:function(e,n,t){var a={type:"getAllTaxiManager"};e.body;return this._platform.runModule("acquisition","getAllVehicleLocationRtData",[function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:{taxi:t}}),n.json(a)}])},getTaxiAndRoadDataManager:function(e,a,t){var o={type:"getTaxiAndRoadDataManager"},i=(e.body,this);return this._platform.runModule("acquisition","getAllVehicleLocationRtData",[function(e,n){e?(o.status=ActionStatus.F,o.error=e,a.json(o)):i._platform.runModule("asset","getAssetListSimpleFormat",[{categoryId:"AC21",aid:"robin"},function(e,t){e?(o.status=ActionStatus.F,o.error=e):(o.status=ActionStatus.S,o.result={data:{taxi:n,road:t}}),a.json(o)}])}])},getIndustryInfoManager:function(e,n,t){var a={type:"getIndustryInfoManager"};e.body;this._langChaoMysqlMethod.getComplexData({dataType:"padIndustryHospitalInfo"},function(e,t){a.status=ActionStatus.S,a.result={data:t},n.json(a)})},getRRoadAirPollutionDataWithCltManager:function(e,n,t){var a={type:"getRRoadAirPollutionDataWithCltManager"};e.body;return this._platform.runModule("acquisition","getRRoadAirPollutionDataWithClt",[null,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)}])},_controlWorkflow:function(e){var t=e.themeName;e.data;if(t)switch(t){case"ZH":break;case"HB":self._pauseWorkFlow();break;case"CG":self._continueWorkFlow(content)}},_runWorkFlowWithCommand:function(e){var t=this;switch(e.eventType){case"ZH_Theme_Start":t._pauseWorkFlow(),t._runWorkFlow({workFlowId:"ZH_Theme",activityId:"ZH_Theme_WorkFlow",workFlowType:"ZH_Theme"});break;case"HB_Theme_Start":t._pauseWorkFlow(),t._runWorkFlow({workFlowId:"EProtectionTheme",activityId:"startEnvironmentalprotection",workFlowType:"HB_Theme"});break;case"CG_Theme_Start":t._pauseWorkFlow(),t._runWorkFlow({workFlowId:"CG_Theme",activityId:"CG_Theme_WorkFlow",workFlowType:"CG_Theme"});break;case"HB_Theme_Finished":t._fireWebSocketEvent({messageKey:"stopIntervalTimer"}),t._runWorkFlow({workFlowId:"CG_Theme",activityId:"CG_Theme_WorkFlow",workFlowType:"CG_Theme"});break;case"ZH_Theme_Finished":clearInterval(t.citytimer),t._runWorkFlow({workFlowId:"EProtectionTheme",activityId:"startEnvironmentalprotection",workFlowType:"HB_Theme"});break;case"CG_Theme_Finished":clearInterval(t.chengGuantimer),t._runWorkFlow({workFlowId:"ZH_Theme",activityId:"ZH_Theme_WorkFlow",workFlowType:"ZH_Theme"})}},_runWorkFlow:function(e){var t=e.flowdataId,n=e.workFlowId,a=e.activityId,o=e.workFlowType,i="";switch(o){case"ZH_Theme":i=t||utilities.getGUID(12),t=zh_FolwdataId=i,this._start_ZH_timer();break;case"HB_Theme":i=t||utilities.getGUID(12),t=hb_FolwdataId=i;break;case"CG_Theme":i=t||utilities.getGUID(12),t=cg_FolwdataId=i,this._start_CG_timer()}CURRENT_FLOWDATA_ID=i;var r={workFlowId:CURRENT_WORKFLOW_ID=n,flowdataid:t,activityid:a,method:"",params:{}};this._fireWebSocketEvent({messageKey:"transformTheme",data:{themeName:o}}),r.params.callback=function(e){console.log("工作流启动成功")};this._platform.runModule("workflow","_executeWorkFlowEngine",[r])},getIndustryInfoByButton:function(e,n,t){var a={type:"IndustryInfo"},o={dataType:"IndustryInfo"};o.num=++testIndustryNum,this._langChaoMysqlMethod.getComplexData(o,function(e,t){a.status=ActionStatus.S,a.result={data:t},n.json(a)})},_start_ZH_timer:function(){var e=-1,t=this,n={dataType:"IndustryInfo"};t.citytimer=setInterval(function(){n.num=++e,t._langChaoMysqlMethod.getComplexData(n,function(e,t){var n={messageKey:"IndustryInfo"};n.content=JSON.stringify(t),EventBus.fireEvent("sendSocketMail",JSON.stringify(n))})},citytimerInterval)},_start_CG_timer:function(){var e=-1,t=this,n={dataType:"CityManage"};t.chengGuantimer=setInterval(function(){n.num=++e,t._langChaoMysqlMethod.getCityManagementData(n,function(e,t){var n={messageKey:"CG_Theme"};n.content=JSON.stringify(t),EventBus.fireEvent("sendSocketMail",JSON.stringify(n))})},chengGuantimerInterval)},_stopWorkFlow:function(e){},_pauseWorkFlow:function(e){return""!=CURRENT_WORKFLOW_ID&&""!=CURRENT_FLOWDATA_ID?(EventBus.fireEvent(CURRENT_WORKFLOW_ID+"_workFlowActivityPause",CURRENT_FLOWDATA_ID),console.log("暂停成功！workFlow"+CURRENT_WORKFLOW_ID),{workFlowId:CURRENT_WORKFLOW_ID,flowdataId:CURRENT_FLOWDATA_ID}):(console.log("暂停失败！workFlow"+CURRENT_WORKFLOW_ID),"没有工作流在运行，暂停无法执行")},_continueWorkFlow:function(e){var t=e?e.workFlowId:CURRENT_WORKFLOW_ID,n=e?e.flowdataId:CURRENT_FLOWDATA_ID;t&&n?(EventBus.fireEvent(t+"_workFlowActivityContinue",n),console.log("启动成功 workFlow"+t)):console.log("无法执行继续指令")},_fireWebSocketEvent:function(e){var t={};t.messageKey=e.messageKey;var n=e.data;t.content=JSON.stringify(n),"websocket"===this.messageSendType&&EventBus.fireEvent("sendSocketMail",JSON.stringify(t),function(){})},controlCurrentWorkFlowManager:function(e,t,n){var a={type:"controlCurrentWorkFlowManager"},o=e.body,i={};switch(o.command){case"pause":i=this._pauseWorkFlow();break;case"continue":var r=o.workflow;i=this._continueWorkFlow(r)}a.status=ActionStatus.S,a.result={data:i},t.json(a)},runWorkFlowManager:function(e,t,n){flowdataId=utilities.getGUID(12);var a={workFlowId:"EProtectionTheme",flowdataid:flowdataId,activityid:"startEnvironmentalprotection",method:"",params:{messageType:"ac"}};a.params.callback=function(e){console.log("工作流启动成功")};this._platform.runModule("workflow","_executeWorkFlowEngine",[a])},stopIntervalTimerManager:function(e,t,n){EventBus.fireEvent("sendSocketMail",JSON.stringify({messageKey:"stopIntervalTimer",result:""}),function(){})},getRankingManager:function(e,n,t){var a={type:"getRankingManager"},o=e.body;return this._langChaoMysqlMethod.getRanking(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})},getRiverQualityDataManager:function(e,n,t){var a={type:"getRiverQualityDataManager"},o=e.body;return this._langChaoMysqlMethod.getRiverQualityData(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})},getComplexDataManager:function(e,n,t){var a={type:"getComplexDataManager"},o=e.body;return this._langChaoMysqlMethod.getComplexData(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})},getCityManagementDataManager:function(e,n,t){var a={type:"getCityManagementDataManager"},o=e.body;return this._langChaoMysqlMethod.getCityManagementData(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})},_run:function(e){this.messageSendType;this._createHotline()},sendJiNanAiqData:function(a){var e=this;setInterval(function(){var n={messageKey:"GET_JINAN_AIQ"};e._langChaoMysqlMethod.simulationJNAiqDate({},function(e,t){e?n.error=e:(n.data=t,"websocket"===a&&EventBus.fireEvent("sendSocketMail",JSON.stringify(n),function(){}))})},3e4)},sendCityRankingData:function(a,e){var t=this;setInterval(function(){var n={};n.messageKey="GET_CITY_RANKING_"+e.rankType,t._langChaoMysqlMethod.getRanking({rankType:e.rankType,cityCode:e.cityCode?e.cityCode:"370100",startTime:e.startTime?e.startTime:""},function(e,t){e?n.error=e:(n.data=t,"websocket"===a&&EventBus.fireEvent("sendSocketMail",JSON.stringify(n),function(){}))})},4e3)}}),Business_Modules.LangchaoBusiness.Module=langchaoModule,Business_Modules.SystemLog={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel"),systemLog={log_id:{type:Sequelize.STRING,allowNull:!1,primaryKey:!0},log_type:{type:Sequelize.STRING,allowNull:!1},action_type:{type:Sequelize.STRING},comments:{type:Sequelize.TEXT},log_time:{type:Sequelize.DATE},operator:{type:Sequelize.STRING},update_contents:{type:Sequelize.TEXT}};sequelizeModel&&sequelizeModel.registerModel("systemLog","sys_log",systemLog),Business_Modules.SystemLog.Model=sequelizeModel;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,ActionStatus=Consts.ActionStatus,ErrorCode=Consts.ErrorCode,Module=fw.Framework.Module,EventBus=utilities.loadSingleInstance("EventBus"),RTData=fw.Framework.RTData,httpAccess=fw.Framework.HttpAccess,SystemLogModule=function(){utilities.callSuper(SystemLogModule,this,arguments),this._name="SystemLogModule";this.focusedEventArray=[{event:"AddLog",onEvent:"onAddLog"}]};utilities.extend(SystemLogModule,RTDataModule,{getExports:function(){return[""]},onAddLog:function(e){var t={type:"onAddLog"};if(e){var n={log_id:utilities.getGUID(12,34),log_type:e.logType,action_type:e.actionType,comments:e.comments?e.comments:"",log_time:utilities.formatDate(new Date,"yyyy-MM-dd hh:ss:mm"),operator:e.operator,update_contents:e.updateContents?e.updateContents:""};model.insert("systemLog",n,function(e){e&&(t.data=e,console.log("log add success"))},function(e){t.error=e,console.log(t)})}return!0}}),Business_Modules.SystemLog.Module=SystemLogModule,Business_Modules.EarthDataSource={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel");Business_Modules.EarthDataSource.Model=sequelizeModel;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,ActionStatus=Consts.ActionStatus,ErrorCode=Consts.ErrorCode,Module=fw.Framework.Module,EventBus=utilities.loadSingleInstance("EventBus"),RTData=fw.Framework.RTData,httpAccess=fw.Framework.HttpAccess,readline=require("readline"),rl=readline.createInterface({input:process.stdin,output:process.stdout}),EarthDataSourceModule=function(){utilities.callSuper(EarthDataSourceModule,this,arguments),this._name="EarthDataSourceModule";this.focusedEventArray=[]};utilities.extend(EarthDataSourceModule,RTDataModule,{getExports:function(){return[""]},runningOnPlatform:function(){utilities.invokeSuper(EarthDataSourceModule,"runningOnPlatform",this,arguments);this.getConsoleInput()},getConsoleInput:function(){},initEarthDataFromPath:function(e){console.log("initEarthDataFromPath:"+e);var t=[];this.readFileList(e,t);for(var n=0;n<t.length;n++){var a=t[n],o={modelId:"AC10-01",assetName:a.filename,description:"EarthData",creator:"sadmin",configure:{data_path:a.path,data_name:a.filename}};this._platform.runModule("asset","addAssetManeger",[o])}},readFileList:function(a,o){var i=this;fs.readdirSync(a).forEach(function(e,t){if(fs.statSync(a+e).isDirectory())i.readFileList(a+e+"/",o);else{var n={};n.path=a,n.filename=e,o.push(n)}})}}),Business_Modules.EarthDataSource.Module=EarthDataSourceModule,Business_Modules.WebService={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel"),enterpriseInfo={qiyefenlei:{type:Sequelize.STRING},company_name:{type:Sequelize.STRING},company_type:{type:Sequelize.STRING},zczb:{type:Sequelize.STRING}};sequelizeModel&&sequelizeModel.registerModel("enterpriseInfo","enterprise_info",enterpriseInfo),Business_Modules.WebService.Model=sequelizeModel;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,EventBus=utilities.loadSingleInstance("EventBus"),RTData=fw.Framework.RTData,acquisitionInstance=null,fs=require("fs"),request=require("request"),async=require("async"),WebServiceModule=function(){utilities.callSuper(WebServiceModule,this,arguments),this._name="WebServiceModule";var e=require("redis");this.redisPushCli=e.createClient(6379,"localhost"),this.DATA_SOURCE="sifang"};utilities.extend(WebServiceModule,RTDataModule,{getExports:function(){return["getTotalPopulationManager","getRankingPopulationManager","getRentalInfoManager","getExPopulationManager","getPopulationSourceManager","getEducationInfoManager","getQYExternalPopulationCount","getRuntimeData","doWebserviceInCommonManager","getEnterpriseInfoManager","getSortCapitalManager"]},runningOnPlatform:function(){utilities.invokeSuper(WebServiceModule,"runningOnPlatform",this,arguments)},getEnterpriseInfoManager:function(e,t,n){var a={type:"getEnterpriseInfoManager"},o=e.body,i=" select * from enterprise_infos where 1=1 ",r={};o.qiyefenlei&&(i+=" and qiyefenlei=:QYFL ",r.QYFL=o.qiyefenlei),o.company_name&&(i+=" and company_name=:CMNAME ",r.CMNAME=o.company_name),o.company_type&&(i+=" and company_type=:CMTYPE ",r.CMTYPE=o.company_type),model.queryFromSql(i,r,function(e){a.status=ActionStatus.S,a.result={data:e},t.json(a)},function(e){a.status=ActionStatus.S,a.error=e,t.json(e)})},getSortCapitalManager:function(e,t,n){var a={type:"getSortCapitalManager"},o=e.body,i=" select * from enterprise_infos ";o.sortParams?i=i+" ORDER BY zczb "+o.sortParams:i+=" ORDER BY zczb desc ",o.limitParams?i=i+" limit "+o.limitParams:i+=" limit 10 ",model.queryFromSql(i,{},function(e){a.status=ActionStatus.S,a.result={data:e},t.json(a)},function(e){a.status=ActionStatus.S,a.error=e,t.json(e)})},insertEnterpriseInfo:function(){this._requestHandle({url:"http://172.23.101.28:9099/miner/public/queryData/jsonData.do?securityKey=1111111111&dataId=AA6C7FE6F0&pageSize=1000&pageIndex=0",method:"GET"},function(e,t){if(e)console.log(e);else{for(var n=t.datas,a=[],o=0;o<n.length;o++){var i=n[o],r={qiyefenlei:i[0],company_name:i[1],company_type:i[2],zczb:i[3]};a.push(r)}model.batchInsert("enterpriseInfo",a,function(e){},function(e){console.log(e)})}})},doWebserviceInCommonManager:function(e,n,t){var a={type:"doWebserviceInCommonManager"},o=e.body,i=o.url,r=o.method,s=o.params;i&&r?this._requestHandle({url:i,method:r,params:s||null},function(e,t){e?(a.error=e,a.status=0):(a.result={data:t},a.status=1),n.json(a)}):(a.error="无效参数",a.status=0,n.json(a))},getDataSetInfo:function(e,a,t){var o={type:"getDataSetInfo"};this._requestFormHandle({method:"post",url:"http://172.23.101.28:9099/poc/external/findBasicInfo",params:{index:1,rows:7,datasetName:"塞瓦"}},function(e,t){if(e)o.error=e,o.status="0",a.json(o);else if("success"===t.message){var n=t.data;o.result={data:n},o.status="1",a.json(o)}})},getRuntimeData:function(e,n,t){var a=this,o=e.body,i=o.indexCode?o.indexCode:null,r=o.objectId?o.objectId:null,s=o.data;s||(s="");var u={INDEXCODE:i,OBJECTID:r,DATA:s};model.insertFromSql("insert into rt (indexcode, objectid, data) values (:INDEXCODE, :OBJECTID, :DATA)",u,function(e){var t={code:"success",desc:"indexCode: "+i+", objectId: "+r};a.redisPushCli.publish("realTimeData",JSON.stringify({indexCode:i,objectId:r,data:s})),a.redisPushCli.on("message",function(e,t){var n=JSON.parse(t);s.type=dataType,s.collectedData=n,protocol.receive(s)}),n.json(t)},function(e){var t={code:"success",desc:"indexCode: "+i+", objectId: "+r};n.json(t)})},_initSFData:function(a){this._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"-1056026209",name:"身份证号"},{id:"-222430174",name:"姓名"},{id:"-483128023",name:"年龄"},{id:"-1170049918",name:"小区名称"},{id:"639540358",name:"小区位置"},{id:"-199240115",name:"学历名称"},{id:"-263070126",name:"户籍省份"},{id:"-322310631",name:"搬来时间"},{id:"1255546770",name:"是否租房"}]),start:0,limit:null,datasetId:"QJjOjKLT9K1zj1ad"}},function(e,t){if(e)a(e);else{var n=(t=JSON.parse(t)).data.query;a(null,n)}})},analysisListData:function(e,t,n){var a={};for(var o in e){var i=e[o],r=i[t];if(n){if(a[r]){var s=a[r];for(var u in s){var l=s[u],d=i[n];l[d]?l[d]=l[d]+1:(l[d]=1,s.push(l[d]))}}}else r&&null!=r&&"undefined"!=r&&(a[r]?a[r]=a[r]+1:a[r]=1)}return a},getTotalPopulationManager:function(e,n,t){var a={type:"getTotalPopulationManager"},o=this,i=e.body,r={indexCode:["39"]},s={};i.city?s[43]=[i.city]:s[43]=["苏州市"],i.area&&(s[31]=[i.area]),i.community&&(s[32]=[i.community]),r.data=s,"sifang"===o.DATA_SOURCE?o._initSFData(function(e,t){e?(a.error=e,a.status="0"):(a.result={data:{"人口数量":t.length,"男":"51.4%","女":"48.6%"}},a.status="1"),n.json(a)}):o._requestHandle({method:"post",url:"http://172.23.101.28:9099/ioc_guoyun/api/getCount",params:r},function(e,t){e?(a.error=e,a.status="0",n.json(a)):"ok"===t.status&&(a.result={data:o._formatResult(t)},a.status="1",n.json(a))})},getRankingPopulationManager:function(e,u,t){var l={type:"getRankingPopulationManager"},d=this,n=e.body,r=n.rankingType,c=n.detailQX;"sifang"===d.DATA_SOURCE?d._getPopulationsFromSF(n,function(e,t){if(e)l.error=e,l.status="0",u.json(l);else{for(var n=[],a=0;a<t.length;a++){var o=t[a],i=[];"区县"===r?(i.push(o["小区位置"]),i.push(o["人口数"]),n.push(i)):"小区"===r&&(i.push(o["小区名称"]),i.push(o["人口数"]),n.push(i)),c&&!r&&n.push({name:o["小区名称"],value:o["人口数"]})}l.result={data:n},l.status="1",u.json(l)}}):d._getAllRanking(function(e,s){if(e)l.error=e,l.status="0",u.json(l);else{var t={};c&&!r?d.initDictionary(function(e,t){if(t&&0<t.length){var n=[],a=[];t.forEach(function(e){e[1]===c&&n.push(e[2])}),n.forEach(function(t){s.xiaoquList.forEach(function(e){e[0]===t&&a.push(e)})});for(var o=[],i=(a=d._sortList(a),0);i<a.length;i++){var r=a[i];o.push({name:r[0],value:r[1]})}l.result={data:o},l.status="1",u.json(l)}}):(t="小区"===r?s.xiaoquList:"区县"===r?s.quyuList:s,l.result={data:t},l.status="1",u.json(l))}})},_getAllRanking:function(a){var o=this;o._requestHandle({method:"post",url:"http://172.23.101.28:9099/ioc_guoyun/api/getSeminar",params:{seminarCode:99}},function(e,t){if(e)a(e);else if("ok"===t.status){var n=o._formatResult(t);a(null,n)}else a("Fail")})},getRentalInfoManager:function(e,a,t){var o={type:"getRentalInfoManager"},i=this,n=e.body.infoType;if("租房人口"===n)"sifang"===i.DATA_SOURCE?i._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"-1446261335",name:"编号"},{id:"-222430174",name:"姓名"},{id:"1255546770",name:"是否租房"}]),where:JSON.stringify({id:null,name:null,operator:0,relation:2,values:[],children:[{id:"1255546770",name:"是否租房",operator:8,relation:1,children:[],values:[1]}]}),start:0,limit:null,datasetId:"QJjOjKLT9K1zj1ad"}},function(e,t){if(e)o.error=e,o.status="0",a.json(o);else{var n=(t=JSON.parse(t)).data.query;o.result={data:{"人口数量":n.length}},o.status="1",a.json(o)}}):i._requestHandle({method:"post",url:"http://172.23.101.28:9099/ioc_guoyun/api/getCount",params:{indexCode:["39"],data:{43:["苏州市"],25:["是"]}}},function(e,t){e?(o.error=e,o.status="0",a.json(o)):"ok"===t.status&&(o.result={data:i._formatResult(t)},o.status="1",a.json(o))});else if("租房人口分布"===n){var r=[],s=[];["吴江区","相城区","姑苏区","工业园区","吴中区"].forEach(function(o){s.push(function(a){"sifang"===i.DATA_SOURCE?i._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"-1446261335",name:"编号"},{id:"-222430174",name:"姓名"},{id:"1255546770",name:"是否租房"}]),where:JSON.stringify({id:null,name:null,operator:0,relation:2,values:[],children:[{id:"639540358",name:"小区位置",operator:8,relation:1,children:[],values:[o]},{id:"1255546770",name:"是否租房",operator:8,relation:1,children:[],values:[1]}]}),start:0,limit:null,datasetId:"QJjOjKLT9K1zj1ad"}},function(e,t){if(e)a(e);else{var n=(t=JSON.parse(t)).data.query;r.push({name:o,value:n.length}),a(null)}}):i._requestHandle({method:"post",url:"http://172.23.101.28:9099/ioc_guoyun/api/getCount",params:{indexCode:["39"],data:{31:[o],25:["是"]}}},function(e,t){if(e)a(e);else if("ok"===t.status){var n=i._formatResult(t);r.push({name:o,value:n["人口数量"]}),a(null)}})})}),async.series(s,function(e,t){e?(o.error=e,o.status="0"):(o.result={data:r},o.status="1"),a.json(o)})}},getExPopulationManager:function(e,s,t){var u={type:"getExPopulationManager"},l=this,d=e.body.dateInfo;"sifang"===l.DATA_SOURCE?"All"===d?l._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"470245992",name:"城市"},{id:"-322310631",name:"搬来日期_年",format:1},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}]),start:0,limit:null,datasetId:"QJjOjKLT9K1zj1ad",cubeId:"dae1ea5141b94f3784aabc52a082e749"}},function(e,t){if(e)u.error=e,u.status="0",s.json(u);else{for(var n=(t=JSON.parse(t)).data.query,a=[],o=0;o<n.length;o++){var i=n[o];a.push({name:i["搬来日期_年"],value:i["人口数"]})}u.result={data:a},u.status="1",s.json(u)}}):d&&"All"!=d&&l._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"-322310631",name:"搬来日期_年",format:1},{id:"-322310631",name:"搬来日期_月",format:2},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}]),start:0,datasetId:"QJjOjKLT9K1zj1ad",cubeId:"dae1ea5141b94f3784aabc52a082e749"}},function(e,t){if(e)u.error=e,u.status="0",s.json(u);else{for(var n=(t=JSON.parse(t)).data.query,a=[],o=0;o<n.length;o++){var i=n[o];i["搬来日期_年"].toString()===d&&a.push({name:i["搬来日期_年"]+"-"+i["搬来日期_月"],value:i["人口数"]})}u.result={data:[a]},u.status="1",s.json(u)}}):l._requestHandle({method:"post",url:"http://172.23.101.28:9099/ioc_guoyun/api/getSeminar",params:{seminarCode:64,data:{65:["苏州市"]}}},function(e,t){if(e)u.error=e,u.status="0",s.json(u);else if("ok"===t.status){var n=l._formatExPopByDate(t.data),a=[];if("All"===d){var o=n.dateObj;for(var i in o)a.push({name:i,value:o[i]})}else if(d&&"All"!=d){var r=n.detailDateObj;a.push(r[d])}u.result={data:a},u.status="1",s.json(u)}})},getPopulationSourceManager:function(e,u,t){var l={type:"getPopulationSourceManager"},d=this,c=(e.body,{"安徽":"117.25,31.83","江西":"115.85,28.68","吉林":"125.32,43.9","浙江":"120.15,30.28","湖南":"112.93,28.23","湖北":"114.3,30.6","河南":"113.62,34.75","辽宁":"123.43,41.8","上海":"121.47,31.23","天津":"117.2,39.12","广州":"113.27,23.13","深圳":"114.05,22.55","北京":"116.4,39.9"});"sifang"===d.DATA_SOURCE?d._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"470245992",name:"城市"},{id:"-263070126",name:"户籍省份"},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}]),start:0,limit:null,datasetId:"QJjOjKLT9K1zj1ad",cubeId:"dae1ea5141b94f3784aabc52a082e749"}},function(e,t){if(e)l.error=e,l.status="0",u.json(l);else{for(var n=(t=JSON.parse(t)).data.query,a=[],o=0;o<n.length;o++){var i=n[o];for(var r in c)r===i["户籍省份"]&&a.push({name:i["户籍省份"],value:i["人口数"],lan:c[r]})}l.result={data:a},l.status="1",u.json(l)}}):d._requestHandle({method:"post",url:"http://172.23.101.28:9099/ioc_guoyun/api/getSeminar",params:{seminarCode:106,data:{107:["安徽","江西","浙江","湖南","湖北","河南","辽宁","上海","天津","广州","深圳","北京"]}}},function(e,t){if(e)l.error=e,l.status="0",u.json(l);else if("ok"===t.status){for(var n=[],a=d._sortList(t.data),o=0;o<a.length;o++){var i="",r=a[o];for(var s in c)s===r[0]&&(i=c[s]);n.push({name:r[0],value:r[1],lan:i})}l.result={data:n},l.status="1",u.json(l)}})},getEducationInfoManager:function(e,s,t){var u={type:"getPopulationSourceManager"},l=this,d=e.body.eduInfo;"sifang"===l.DATA_SOURCE?"All"===d?l._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"470245992",name:"城市"},{id:"-199240115",name:"学历名称"},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}]),start:0,datasetId:"QJjOjKLT9K1zj1ad",cubeId:"dae1ea5141b94f3784aabc52a082e749"}},function(e,t){if(e)u.error=e,u.status="0",s.json(u);else{for(var n=(t=JSON.parse(t)).data.query,a=[],o=0;o<n.length;o++){var i=n[o];a.push({name:i["学历名称"],value:i["人口数"]})}u.result={data:a},u.status="1",s.json(u)}}):d&&"All"!=d&&l._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"639540358",name:"小区位置"},{id:"-199240115",name:"学历名称"},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}]),where:JSON.stringify({id:null,name:null,operator:0,relation:2,values:[],children:[{id:"-199240115",name:"学历名称",operator:8,relation:1,children:[],values:[d]}]}),start:0,datasetId:"QJjOjKLT9K1zj1ad",cubeId:"dae1ea5141b94f3784aabc52a082e749"}},function(e,t){if(e)u.error=e,u.status="0",s.json(u);else{for(var n=(t=JSON.parse(t)).data.query,a=[],o=0;o<n.length;o++){var i=n[o];a.push({name:i["小区位置"],value:i["人口数"]})}u.result={data:[a]},u.status="1",s.json(u)}}):l._requestHandle({method:"post",url:"http://172.23.101.28:9099/ioc_guoyun/api/getSeminar",params:{seminarCode:112}},function(e,t){if(e)u.error=e,u.status="0",s.json(u);else if("ok"===t.status){var n=l._formatCacuByArea(t.data),a=[];if("All"===d){var o=n.xueli;for(var i in o)a.push({name:i,value:o[i]})}else if(d&&"All"!=d){var r=n.quxian;a.push(r[d])}u.result={data:a},u.status="1",s.json(u)}})},getQYExternalPopulationCount:function(e,c,t){var g={type:"getQYExternalPopulationCount"},m=e.body.type,n=[];n=0===m?["苏州市"]:["工业园区","吴中区","吴江区","相城区","虎丘区","姑苏区"],"sifang"===this.DATA_SOURCE?this._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"470245992",name:"城市"},{id:"639540358",name:"小区位置"},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}]),start:0,limit:null,datasetId:"QJjOjKLT9K1zj1ad",cubeId:"dae1ea5141b94f3784aabc52a082e749"}},function(e,t){if(e)g.error=e,g.status="0",c.json(g);else{for(var n=(t=JSON.parse(t)).data.query,a=[],o=0;o<n.length;o++){var i=n[o];a.push({name:i["小区位置"],value:i["人口数"]})}g.result={data:a},g.status="1",c.json(g)}}):this._requestHandle({method:"post",url:"http://172.23.101.28:9099/ioc_guoyun/api/getSeminar",params:{seminarCode:64,data:{65:n}}},function(e,t){if(e)g.error=e,g.status="0",c.json(g);else if("ok"===t.status){var n=t.data;if(0===m){for(var a=0,o=0;o<n.length;o++){a+=n[o][3]}g.result={data:{name:"苏州市",value:a}}}else{for(var i=[],r=0;r<n.length;r++){for(var s=n[r],u=s[0],l=s[3],d=0;d<i.length;d++){if(i[d].name===u){i[d].value+=l;break}}d>=i.length&&i.push({name:u,value:l})}g.result={data:i}}g.status="1",c.json(g)}})},_getPopulationsFromSF:function(e,a){var t=e.rankingType,n=e.detailQX,o="",i="";"区县"===t?(o="",i=JSON.stringify([{id:"470245992",name:"城市"},{id:"639540358",name:"小区位置"},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}])):(o="",i=JSON.stringify([{id:"470245992",name:"城市"},{id:"639540358",name:"小区位置"},{id:"-1170049918",name:"小区名称"},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}])),n&&!t&&(o=JSON.stringify({id:null,name:null,operator:0,relation:2,values:[],children:[{id:"639540358",name:"小区位置",operator:8,relation:1,children:[],values:[n]}]}),i=JSON.stringify([{id:"470245992",name:"城市"},{id:"639540358",name:"小区位置"},{id:"-1170049918",name:"小区名称"},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}])),this._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:i,where:o,start:0,limit:null,datasetId:"QJjOjKLT9K1zj1ad",cubeId:"dae1ea5141b94f3784aabc52a082e749",orders:JSON.stringify([{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",orderType:2}])}},function(e,t){if(e)a(e);else{var n=(t=JSON.parse(t)).data.query;a(null,n)}})},testSFmanager:function(e,t,n){this._requestFormHandle({url:"http://172.23.101.28:9099/poc/external/queryDimension",method:"post",params:{columns:JSON.stringify([{id:"-322310631",name:"搬来日期"},{id:"639540358",name:"小区位置"},{id:"-1170049918",name:"小区名称"},{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",aggregation:"1"}]),where:JSON.stringify({id:null,name:null,operator:0,relation:2,values:[],children:[{id:"639540358",name:"小区位置",operator:8,relation:1,children:[],values:["吴中区"]}]}),start:0,limit:100,datasetId:"QJjOjKLT9K1zj1ad",cubeId:"dae1ea5141b94f3784aabc52a082e749",orders:JSON.stringify([{id:"96c4af87b171449487f9c1054539e19f",name:"人口数",orderType:1}])}},function(e,t){})},_formatCacuByArea:function(e){var t={},n={};return e.forEach(function(e){"未上学"==e[1]&&(t["未上学"]=t["未上学"]?t["未上学"]+e[2]:e[2],n["未上学"]?n["未上学"].push({name:e[0],value:e[2]}):n["未上学"]=[{name:e[0],value:e[2]}]),"小学"==e[1]&&(t["小学"]=t["小学"]?t["小学"]+e[2]:e[2],n["小学"]?n["小学"].push({name:e[0],value:e[2]}):n["小学"]=[{name:e[0],value:e[2]}]),"初中"==e[1]&&(t["初中"]=t["初中"]?t["初中"]+e[2]:e[2],n["初中"]?n["初中"].push({name:e[0],value:e[2]}):n["初中"]=[{name:e[0],value:e[2]}]),"高中"==e[1]&&(t["高中"]=t["高中"]?t["高中"]+e[2]:e[2],n["高中"]?n["高中"].push({name:e[0],value:e[2]}):n["高中"]=[{name:e[0],value:e[2]}]),"大专"==e[1]&&(t["大专"]=t["大专"]?t["大专"]+e[2]:e[2],n["大专"]?n["大专"].push({name:e[0],value:e[2]}):n["大专"]=[{name:e[0],value:e[2]}]),"本科"==e[1]&&(t["本科"]=t["本科"]?t["本科"]+e[2]:e[2],n["本科"]?n["本科"].push({name:e[0],value:e[2]}):n["本科"]=[{name:e[0],value:e[2]}]),"本科985"==e[1]&&(t["本科985"]=t["本科985"]?t["本科985"]+e[2]:e[2],n["本科985"]?n["本科985"].push({name:e[0],value:e[2]}):n["本科985"]=[{name:e[0],value:e[2]}])}),{xueli:t,quxian:n}},_formatExPopByDate:function(e){var t={},n={2009:[],2010:[],2011:[],2012:[]};return e.forEach(function(e){"2009"==e[1]&&(t[2009]=t[2009]?t[2009]+e[3]:e[3],n[2009].push({name:e[2],value:e[3]})),"2010"==e[1]&&(t[2010]=t[2010]?t[2010]+e[3]:e[3],n[2010].push({name:e[2],value:e[3]})),"2011"==e[1]&&(t[2011]=t[2011]?t[2010]+e[3]:e[3],n[2011].push({name:e[2],value:e[3]})),"2012"==e[1]&&(t[2012]=t[2012]?t[2012]+e[3]:e[3],n[2012].push({name:e[2],value:e[3]}))}),{dateObj:t,detailDateObj:n}},initDictionary:function(n){this._requestHandle({method:"get",url:"http://172.23.101.28:9099/ioc_guoyun/api/dictionary?dictionaryId=50"},function(e,t){e?n(e):"ok"===t.status?n(null,t.data):n("Fail")})},_formatResult:function(e,t){if(e){var n=e.metadata,a=e.data,o=n[0];if("人口数量"===o.name)return{"人口数量":a[0][0],"男":"51.4%","女":"48.6%"};if("区域"===o.name){var i=a.slice(0,71),r=a.slice(72,77);return{xiaoquList:this._sortList(i),quyuList:this._sortList(r)}}}},_sortList:function(e,t){if(e&&0<e.length)return e.sort(function(e,t){return t[1]-e[1]}),e},_requestHandle:function(e,a){request({url:e.url,method:e.method,json:!0,headers:{"content-type":"application/json"},body:e.params},function(e,t,n){e||200!=t.statusCode||a(null,n)})},_requestFormHandle:function(e,a){request({url:e.url,method:e.method,headers:{"content-type":"application/application/x-www-form-urlencoded;charset=UTF-8"},form:e.params},function(e,t,n){e||200!=t.statusCode?a("fail"):a(null,n)})}}),Business_Modules.WebService.Module=WebServiceModule,Business_Modules.UploadFile={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel"),uploadSettings={setid:{type:Sequelize.STRING,primaryKey:!0},filetype:{type:Sequelize.STRING,allowNull:!1},maxfiledsize:{type:Sequelize.STRING,allowNull:!1},filepath:{type:Sequelize.STRING},comments:{type:Sequelize.TEXT}};sequelizeModel&&sequelizeModel.registerModel("uploadSettings","upload_settings",uploadSettings),Business_Modules.UploadFile.Model=sequelizeModel;var fw=require("../../../libs/f"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,ActionStatus=Consts.ActionStatus,EventBus=utilities.loadSingleInstance("EventBus"),UploadFileModule=function(){utilities.callSuper(UploadFileModule,this,arguments),this._name="UploadFileModule"};utilities.extend(UploadFileModule,RTDataModule,{getExports:function(){return["uploadImgFile","upsertUploadSettingsManager","getUploadSettingsManager","uploadFileManager","getAllUploadFliesManager"]},uploadImgFile:function(e,t,n){this._platform.runModule("uploading","uploading",[e,t,n,"ticket"+e.url])},getAllUploadFliesManager:function(e,n,t){var a={type:"getAllUploadFliesManager"},o=this._platform._settings.moduleSettings.uploading.uploadDir+".staticFiles";fs.readdir(o,function(e,t){e?(a.error=e,a.status=ActionStatus.F):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})},uploadFileManager:function(a,o,e){var i={type:"uploadFileManager"},r=this;r._getUploadSettings(null,function(e,t){if(e)i.status=ActionStatus.F,i.error=e,o.json(i);else if(data){var n={project:"staticFiles",notRename:!0,filetype:t.filetype,maxfieldssize:t.maxfiledsize,req:a,callback:function(e,t){e?(i.status=ActionStatus.F,i.error=e,o.json(i)):console.log(t)}};r._platform.runModule("uploading","uploadFile",[n])}else i.status=ActionStatus.F,i.error={message:"请先设置上传配置"},o.json(i)})},getUploadSettingsManager:function(e,n,t){var a={type:"getUploadSettingsManager"};e.body;this._getUploadSettings(null,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t}),n.json(a)})},_getUploadSettings:function(e,n){model.query("uploadSettings",{},function(e){var t=null;e.length&&(t=e[0].dataValues),n(null,t)},function(e){n(e)})},upsertUploadSettingsManager:function(e,t,n){var a={type:"upsertUploadSettingsManager"},o=e.body.settingsValue;o&&(o.setid||(o.setid=utilities.getGUID(12,24)),model.upsert("uploadSettings",o,function(e){a.status=ActionStatus.S,a.result={data:1},t.json(a)},function(e){a.status=ActionStatus.F,a.error=e,t.json(a)}))}}),Business_Modules.UploadFile.Module=UploadFileModule,Business_Modules.NanruiBusiness={};var Sequelize=require("sequelize"),sequelizeModel=require("../../../libs/f").Framework.Utilities.loadSingleInstance("sequelizeModel");Business_Modules.NanruiBusiness.Model=sequelizeModel;var fw=require("../../../libs/f"),XLSX=require("xlsx"),utilities=fw.Framework.Utilities,model=utilities.loadSingleInstance("sequelizeModel"),Consts=fw.Framework.Consts,RTDataModule=fw.Framework.RTDataModule,ActionStatus=Consts.ActionStatus,EventBus=utilities.loadSingleInstance("EventBus"),neo4j=fw.Framework.Neo4j,neo4jModel=new neo4j,NanruiBusinessModule=function(){utilities.callSuper(NanruiBusinessModule,this,arguments),this._name="NanruiBusinessModule"};utilities.extend(NanruiBusinessModule,RTDataModule,{getExports:function(){return["getTransformerInfoManager","getUserByTransformerManager","getTerminalInfoManager","getUserInfoManager","getCommunityInfoByTransformerManager","getLineInfoManager"]},runningOnPlatform:function(e){utilities.invokeSuper(NanruiBusinessModule,"runningOnPlatform",this,arguments)},getTransformerInfoManager:function(e,n,t){var a={type:"getTransformerInfoManager"},o=e.body.transformerName;this.getTransformerInfo(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.result={data:t.data},a.status=ActionStatus.S),n.json(a)})},getTransformerInfo:function(e,n){var t={},a=" match (n:`变压器`) where 1=1 ";e&&(a+=" and n.name={transformerName} ",t.transformerName=e),a+=" return n",neo4jModel.query(a,t,function(e,t){e?n(e):n(null,t)})},getUserByTransformerManager:function(e,n,t){var a={type:"getUserByTransformerManager"},o=e.body.transformerName;this.getUserByTransformer(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t.data}),n.json(a)})},getUserByTransformer:function(e,n){if(e){neo4jModel.query(" match (n:`变压器`)<-[:`终端`]-(z:`终端`)<-[:`用户`]-(u:`用户`)  where n.`变压器名称`={transformerName} return u as user ",{transformerName:e},function(e,t){e?n(e):n(null,t)})}else n("没有变压器名")},getTerminalInfoManager:function(e,n,t){var a={type:"getTerminalInfoManager"},o=e.body.terminalName;this.getTerminalInfo(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t.data}),n.json(a)})},getTerminalInfo:function(e,n){var t=" match (n:终端) where 1=1 ",a={};e&&(t+=" and n.`终端地址`={terminalName} ",a.terminalName=e),t+=" return n ",neo4jModel.query(t,a,function(e,t){e?n(e):n(null,t)})},getUserInfoManager:function(e,n,t){var a={type:"getUserInfoManager"},o=e.body.userName;this.getUserInfo(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t.data}),n.json(a)})},getUserInfo:function(e,n){var t=" match (n:`用户`) where 1=1 ",a={};e&&(t+=" and n.`用户编号`={userName} ",a.userName=e),t+=" return n ",neo4jModel.query(t,a,function(e,t){e?n(e):n(null,t)})},getCommunityInfoByTransformerManager:function(e,n,t){var a={type:"getCommunityInfoByTransformerManager"},o=e.body.transformerName;this.getCommunityInfoByTransformer(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t.data}),n.json(a)})},getCommunityInfoByTransformer:function(e,n){if(e){neo4jModel.query(" match (b:`变压器`)<-[:`终端`]-(z:`终端`)<-[:`用户`]-(y:`用户`)-[:`小区在`]->(x:`小区`)  where b.`变压器名称`={transformerName} return distinct x ",{transformerName:e},function(e,t){e?n(e):n(null,t)})}else n("没有变压器名")},getLineInfoManager:function(e,n,t){var a={type:"getLineInfoManager"},o=e.body.lineName;this.getLineInfo(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t.data}),n.json(a)})},getLineInfo:function(e,r){var t=" match (n:`供电单位`) where 1=1 ",n={};e&&(t+=" and n.`线路名称`={lineName} ",n.lineName=e),t+=" return n ",neo4jModel.query(t,n,function(e,t){if(e)r(e);else{for(var n=t.data,a=0;a<n.length;a++){var o=utilities.getRandomInt(0,2),i=n[a];n[a]["变压器故障数"]=o,n[a]["停电用户数"]=Math.round(i["用户数"]*(.01*utilities.getRandomInt(1,7))*o)}r(null,t)}})},getTransformerManager:function(e,n,t){var a={type:"getTransformerManager"},o=e.body.traName;this.getTransformer(o,function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t.data}),n.json(a)})},getTransformer:function(e,n){var t=" match (n:`变压器`) where 1=1 ",a={};e&&(t+=" and n.`变压器名称`={traName} ",a.traName=e),t+=" return n ",neo4jModel.query(t,a,function(e,t){e?n(e):n(null,t)})},getTransformerByLineNameManager:function(e,r,t){var s={type:"getTransformerByLineNameManager"},n=e.body.lineName,a=" match (n:`供电单位`)<-[:`变压器`]-(m:`变压器`) where 1=1 ",o={};n&&(a+=" and n.`线路名称`={lineName} ",o.lineName=n),a+=" return m ",neo4jModel.query(a,o,function(e,t){if(e)s.status=ActionStatus.F,s.error=e,r.json(s);else{for(var n=t.data,a=utilities.getRandomInt(1,n.length),o=0;o<n.length;o++){var i=1;o==a&&(i=0),n[o].status=i}s.status=ActionStatus.S,s.result={data:n},r.json(s)}})},getTotalInfoManager:function(e,n,t){var a={type:"getTotalInfoManager"};e.body;neo4jModel.query(" match (n:`供电单位`) RETURN sum(n.`用户数`) as 供电人口, count(n) as 馈线数量, sum(n.`变压器数量`)  as 变压器总数 ",{},function(e,t){e?(a.status=ActionStatus.F,a.error=e):(a.status=ActionStatus.S,a.result={data:t[0]}),n.json(a)})},getElectricMeterTotalInfoManager:function(e,t,n){var a={type:"getElectricMeterTotalInfoManager"},o=e.body.infoType,i=26349,r=Math.round(i*(.01*utilities.getRandomInt(0,9))),s=[],u=[{name:"故障数",value:r},{name:"新装数",value:Math.round(i*(.01*utilities.getRandomInt(1,15)))},{name:"换装数",value:Math.round(i*(.01*utilities.getRandomInt(1,10)))},{name:"运行总数",value:i}],l=[{name:"其他",value:Math.round(.05*r)},{name:"计量异常",value:Math.round(.15*r)},{name:"时钟异常",value:Math.round(.1*r)},{name:"无冻结示数",value:Math.round(.25*r)},{name:"欠压",value:Math.round(.04*r)},{name:"开表盖",value:Math.round(.2*r)},{name:"潜动",value:Math.round(.21*r)}];"AllElectricMeter"===o?s=u:"badElectricMeter"===o&&(s=l),a.status=ActionStatus.S,a.result={data:s},t.json(a)},getTerminalTotalInfoManager:function(e,t,n){var a={type:"getTerminalTotalInfoManager"},o=e.body.infoType,i=Math.round(.01*utilities.getRandomInt(0,9)*289),r=[],s=[{name:"故障数",value:i},{name:"新装数",value:Math.round(.01*utilities.getRandomInt(1,15)*289)},{name:"换装数",value:Math.round(.01*utilities.getRandomInt(1,10)*289)},{name:"运行总数",value:289},{name:"在线数",value:289-i}],u=[{name:"载波信号异常",value:Math.round(.05*i)},{name:"参数异常",value:Math.round(.05*i)},{name:"长时间不在线",value:Math.round(.1*i)},{name:"通信模块",value:Math.round(.25*i)},{name:"路由异常",value:Math.round(.04*i)},{name:"通信端口",value:Math.round(.2*i)},{name:"安装异常",value:Math.round(.15*i)},{name:"时钟异常",value:Math.round(.06*i)},{name:"SIM卡故障",value:Math.round(.1*i)}];"AllTerminal"===o?r=s:"badTerminal"===o&&(r=u),a.status=ActionStatus.S,a.result={data:r},t.json(a)},importNanruiData:function(){var t=this,e={};try{e=XLSX.readFile(__dirname+"/nanruiDataSource.xls")}catch(e){return void console.log("无可导入的数据")}t._getExcelValue(e,function(e){t.insertToGraphDB(e)})},importXiaoquData:function(){var t=this,e={};try{e=XLSX.readFile(__dirname+"/nanruiDataSource.xls")}catch(e){return void console.log("无可导入的数据")}t._getExcelValue(e,function(e){t.insertXiaoQuDataToGraphDB(e)})},insertXiaoQuDataToGraphDB:function(e){var o=this;if(0<e.length){var t=[];e.forEach(function(a){t.push(function(e){var t=o._getXiaoQuName(a["台区名称"]),n={labels:["小区"],properties:{name:t,"小区名称":t}};o.insertNodeFroXiaoQu(n,{labels:"用户",name:a["用户编号"]},"小区在",e)})}),async.series(t,function(e,t){e?consolg.log(e):console.log("小区数据导入成功")})}},_getXiaoQuName:function(e){if(e){if(0<=e.indexOf("电网")){var t=e.indexOf("_")+1,n=0;return 0<=e.indexOf("箱变")?n=e.indexOf("箱变"):0<=e.indexOf("配")&&(n=e.indexOf("配")),e.substring(t,n)}return e}},insertToGraphDB:function(e){var r=this;if(0<e.length){var t=[];e.forEach(function(i){t.push(function(n){var e={labels:["变压器"],properties:{name:i["变压器名称"],"变压器名称":i["变压器名称"],"台区名称":i["台区名称"],"合同容量":i["合同容量"],"运行容量":i["运行容量"],"电压等级":i["电压等级"],"经纬度":"87.59164,43.82255"}},a={labels:["终端"],properties:{name:i["终端地址"],"终端地址":i["终端地址"]}},o={labels:["用户"],properties:{name:i["用户编号"],"用户编号":i["用户编号"],"用户名称":i["用户名称"]}};r.insertNodeNoExists(e,{labels:"供电单位",name:"南湖供电所"},"变压器",function(e,t){e?n(e):r.insertNodeNoExists(a,{labels:"变压器",name:i["变压器名称"]},"终端",function(e,t){e?n(e):r.insertNodeNoExists(o,{labels:"终端",name:i["终端地址"]},"用户",n)})})})}),async.series(t,function(e,t){e&&console.log(e)})}},insertNodeFroXiaoQu:function(a,o,i,r){var s=a.labels,e=" match (n:"+s[0]+") where n.name={NODE_NAME} return n";neo4jModel.query(e,{NODE_NAME:a.properties.name},function(e,t){if(e)r(e);else if(0==t.data.length)neo4jModel.createNode(a,function(e,t){if(e)r(e);else{var n=" match (n:"+o.labels+"{name:'"+o.name+"'}), (m:"+s[0]+"{name:'"+a.properties.name+"'}) create (m)<-[:"+i+"]-(n)";neo4jModel.query(n,{},function(e,t){e?r(e):r(null,"")})}});else{var n=" match (n:"+o.labels+"{name:'"+o.name+"'}), (m:"+s[0]+"{name:'"+a.properties.name+"'}) create (m)<-[:"+i+"]-(n)";neo4jModel.query(n,{},function(e,t){e?r(e):r(null,"")})}})},insertNodeNoExists:function(a,o,i,r){var s=a.labels,e=" match (n:"+s[0]+") where n.name={NODE_NAME} return n";neo4jModel.query(e,{NODE_NAME:a.properties.name},function(e,t){if(e)r(e);else{if(0!=t.data.length)return void r(null,"");neo4jModel.createNode(a,function(e,t){if(e)r(e);else{var n=" match (n:"+o.labels+"{name:'"+o.name+"'}), (m:"+s[0]+"{name:'"+a.properties.name+"'}) create (m)-[:"+i+"]->(n)";neo4jModel.query(n,{},function(e,t){e?r(e):r(null,"")})}})}})},_getExcelValue:function(u,l){u.SheetNames.forEach(function(e){var t=u.Sheets[e],n=[],a={};for(var o in t)if("!"!==o[0]){var i=o.substring(0,1),r=parseInt(o.substring(1)),s=t[o].w;1===r?a[i]=s:1<r&&(n[r-2]||(n[r-2]={}),n[r-2][a[i]]=s)}l(n)})}}),Business_Modules.NanruiBusiness.Module=NanruiBusinessModule}(),exports.Business_Modules=Business_Modules;
